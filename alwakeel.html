import React, { useState, useEffect } from 'react';
import { User, BookOpen, FileText, Award, BarChart3, Bell, Plus, Eye, Edit, Download, MapPin, Clock, Users, AlertTriangle, Settings, Shield, Save, Search, CheckCircle, XCircle } from 'lucide-react';

const ViceDirectorPlatform = () => {
  const [activeSection, setActiveSection] = useState('dashboard');
  const [searchTerm, setSearchTerm] = useState('');
  const [showAlert, setShowAlert] = useState(null);
  
  // تحميل البيانات من localStorage عند بدء التطبيق
  const [behaviorRecords, setBehaviorRecords] = useState(() => {
    const savedRecords = localStorage.getItem('behaviorRecords');
    if (savedRecords) {
      try {
        return JSON.parse(savedRecords);
      } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        return getDefaultRecords();
      }
    }
    return getDefaultRecords();
  });

  function getDefaultRecords() {
    return [
      {
        id: 1,
        studentName: 'أحمد محمد العتيبي',
        grade: 'الصف الأول المتوسط',
        section: '1',
        behavior: 'التهاون في أداء الصلاة مع الجماعة',
        location: 'المصلى',
        rule: 'التهاون في أداء الصلاة',
        category: 'الدرجة الثالثة',
        pointsDeducted: 3,
        action: 'إشعار ولي الأمر + تعهد خطي',
        positiveAction: 'الانضباط في الصلاة لمدة أسبوعين',
        status: 'قيد المعالجة',
        date: '2025-08-30',
        time: '12:30',
        witnesses: 'أ. سالم المناوب',
        createdBy: 'نواف الصبحي',
        lastUpdated: new Date().toISOString()
      },
      {
        id: 2,
        studentName: 'سعد علي الزهراني',
        grade: 'الصف الثاني المتوسط',
        section: '2',
        behavior: 'التأخر عن الطابور الصباحي والدخول بدون إذن',
        location: 'البوابة الرئيسية',
        rule: 'التأخر أو العبث أثناء الاصطفاف الصباحي',
        category: 'الدرجة الأولى',
        pointsDeducted: 1,
        action: 'تنبيه شفهي + تسجيل في النظام',
        positiveAction: 'الالتزام بالطابور لمدة أسبوع',
        status: 'مكتمل',
        date: '2025-08-30',
        time: '07:45',
        witnesses: 'أ. محمد المناوب',
        createdBy: 'نواف الصبحي',
        lastUpdated: new Date().toISOString()
      }
    ];
  }

  const [newRecord, setNewRecord] = useState({
    studentName: '',
    grade: '',
    section: '',
    behavior: '',
    location: '',
    rule: '',
    category: '',
    pointsDeducted: 0,
    customPoints: '',
    action: '',
    positiveAction: '',
    customPositiveAction: '',
    witnesses: '',
    time: ''
  });

  // حفظ البيانات في localStorage عند تغييرها
  useEffect(() => {
    try {
      localStorage.setItem('behaviorRecords', JSON.stringify(behaviorRecords));
    } catch (error) {
      showAlertMessage('خطأ في حفظ البيانات', 'error');
    }
  }, [behaviorRecords]);

  // عرض رسائل التنبيه
  const showAlertMessage = (message, type = 'success') => {
    setShowAlert({ message, type });
    setTimeout(() => setShowAlert(null), 5000);
  };

  // قواعد السلوك حسب الوثيقة الرسمية
  const behaviorRules = {
    firstDegree: [
      { rule: 'عدم التقيد باللباس الرسمي', points: 1, category: 'الدرجة الأولى' },
      { rule: 'التأخر أو العبث أثناء الاصطفاف الصباحي', points: 1, category: 'الدرجة الأولى' },
      { rule: 'إعاقة سير الحصة الدراسية', points: 1, category: 'الدرجة الأولى' },
      { rule: 'تكرار دخول وخروج الطلبة من البوابة', points: 1, category: 'الدرجة الأولى' },
      { rule: 'أخرى', points: 0, category: 'الدرجة الأولى' }
    ],
    secondDegree: [
      { rule: 'إثارة الفوضى داخل الفصل أو المدرسة', points: 2, category: 'الدرجة الثانية' },
      { rule: 'الخروج من الفصل بدون استئذان', points: 2, category: 'الدرجة الثانية' },
      { rule: 'أخرى', points: 0, category: 'الدرجة الثانية' }
    ],
    thirdDegree: [
      { rule: 'التهاون في أداء الصلاة', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'الإشارة بحركات مخلة بالأدب', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'الاشتراك في مضاربة أو مهاجمة الزملاء', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'إلحاق الضرر بممتلكات الزملاء', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'حيازة المواد الإعلامية الممنوعة', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'التوقيع عن ولي الأمر بدون علمه', points: 3, category: 'الدرجة الثالثة' },
      { rule: 'أخرى', points: 0, category: 'الدرجة الثالثة' }
    ],
    fourthDegree: [
      { rule: 'الإصرار على ترك أداء الصلاة', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'التدخين داخل المدرسة', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'الهروب من المدرسة', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'التنمر', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'العبث بتجهيزات المدرسة', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'التسجيل الصوتي للطلبة', points: 10, category: 'الدرجة الرابعة' },
      { rule: 'أخرى', points: 0, category: 'الدرجة الرابعة' }
    ],
    fifthDegree: [
      { rule: 'التحرش', points: 15, category: 'الدرجة الخامسة' },
      { rule: 'إشعال النار داخل المدرسة', points: 15, category: 'الدرجة الخامسة' },
      { rule: 'حيازة أسلحة أو مواد حادة', points: 15, category: 'الدرجة الخامسة' },
      { rule: 'الجرائم المعلوماتية', points: 15, category: 'الدرجة الخامسة' },
      { rule: 'حيازة أو تعاطي المخدرات', points: 15, category: 'الدرجة الخامسة' },
      { rule: 'أخرى', points: 0, category: 'الدرجة الخامسة' }
    ]
  };

  // أماكن المدرسة
  const schoolLocations = [
    { id: 'mosque', name: 'المصلى' },
    { id: 'entrance', name: 'البوابة الرئيسية' },
    { id: 'yard', name: 'ساحة المدرسة' },
    { id: 'hallway', name: 'الممرات' },
    { id: 'cafeteria', name: 'المقصف' },
    { id: 'bathroom', name: 'دورات المياه' },
    { id: 'classroom', name: 'الفصل الدراسي' },
    { id: 'lab', name: 'المختبر' },
    { id: 'library', name: 'المكتبة' }
  ];

  // خيارات التعويض الإيجابي
  const compensationOptions = [
    'الانضباط وعدم الغياب لمدة أسبوعين (2 درجة)',
    'المحافظة على الهوية الوطنية (3 درجات)',
    'مبادرات وأعمال تطوعية (3 درجات)',
    'مشاركات إذاعية أو أنشطة (2 درجة)',
    'المحافظة على الممتلكات العامة (2 درجة)',
    'التعاون مع الزملاء والمعلمين (2 درجة)',
    'برنامج التطوير الشخصي (2 درجة)',
    'تقديم مقترحات تطويرية (1 درجة)',
    'أخرى'
  ];

  // التحقق من صحة البيانات
  const validateRecord = () => {
    const required = ['studentName', 'grade', 'section', 'behavior', 'location', 'rule', 'action'];
    const missing = required.filter(field => !newRecord[field] || newRecord[field].trim() === '');
    
    if (missing.length > 0) {
      showAlertMessage('يرجى ملء جميع الحقول المطلوبة', 'error');
      return false;
    }
    
    if (newRecord.rule === 'أخرى' && (!newRecord.customPoints || newRecord.customPoints <= 0)) {
      showAlertMessage('يرجى إدخال الدرجة المخصومة للمخالفة المخصصة', 'error');
      return false;
    }
    
    return true;
  };

  const handleRuleChange = (rule) => {
    const allRules = [
      ...behaviorRules.firstDegree,
      ...behaviorRules.secondDegree,
      ...behaviorRules.thirdDegree,
      ...behaviorRules.fourthDegree,
      ...behaviorRules.fifthDegree
    ];
    const selectedRule = allRules.find(r => r.rule === rule);
    setNewRecord({
      ...newRecord,
      rule: rule,
      pointsDeducted: selectedRule && selectedRule.points > 0 ? selectedRule.points : 0,
      category: selectedRule ? selectedRule.category : '',
      customPoints: selectedRule && selectedRule.points === 0 ? newRecord.customPoints : ''
    });
  };

  const handleAddRecord = () => {
    if (!validateRecord()) return;

    const finalPoints = newRecord.rule === 'أخرى' ? parseInt(newRecord.customPoints) || 0 : newRecord.pointsDeducted;
    const finalPositiveAction = newRecord.positiveAction === 'أخرى' ? newRecord.customPositiveAction : newRecord.positiveAction;
    
    const record = {
      ...newRecord,
      id: Math.max(...behaviorRecords.map(r => r.id), 0) + 1,
      pointsDeducted: finalPoints,
      positiveAction: finalPositiveAction,
      status: 'قيد المعالجة',
      date: new Date().toISOString().split('T')[0],
      time: newRecord.time || new Date().toLocaleTimeString('ar-SA', { hour12: false }).slice(0,5),
      createdBy: 'نواف الصبحي',
      lastUpdated: new Date().toISOString()
    };
    
    setBehaviorRecords([record, ...behaviorRecords]);
    setNewRecord({
      studentName: '',
      grade: '',
      section: '',
      behavior: '',
      location: '',
      rule: '',
      category: '',
      pointsDeducted: 0,
      customPoints: '',
      action: '',
      positiveAction: '',
      customPositiveAction: '',
      witnesses: '',
      time: ''
    });
    
    showAlertMessage('تم حفظ المخالفة بنجاح', 'success');
    setActiveSection('all');
  };

  const getStatusColor = (status) => {
    switch(status) {
      case 'قيد المعالجة': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
      case 'يحتاج متابعة': return 'bg-red-100 text-red-800 border-red-300';
      case 'مكتمل': return 'bg-green-100 text-green-800 border-green-300';
      default: return 'bg-gray-100 text-gray-800 border-gray-300';
    }
  };

  const getCategoryColor = (category) => {
    switch(category) {
      case 'الدرجة الأولى': return 'bg-blue-100 text-blue-800 border-blue-300';
      case 'الدرجة الثانية': return 'bg-green-100 text-green-800 border-green-300';
      case 'الدرجة الثالثة': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
      case 'الدرجة الرابعة': return 'bg-orange-100 text-orange-800 border-orange-300';
      case 'الدرجة الخامسة': return 'bg-red-100 text-red-800 border-red-300';
      default: return 'bg-gray-100 text-gray-800 border-gray-300';
    }
  };

  const updateStatus = (id, newStatus) => {
    setBehaviorRecords(behaviorRecords.map(record => 
      record.id === id ? { ...record, status: newStatus, lastUpdated: new Date().toISOString() } : record
    ));
    showAlertMessage('تم تحديث الحالة بنجاح', 'success');
  };

  // تصفية البيانات حسب البحث
  const filteredRecords = behaviorRecords.filter(record => 
    record.studentName.includes(searchTerm) ||
    record.behavior.includes(searchTerm) ||
    record.location.includes(searchTerm) ||
    record.rule.includes(searchTerm)
  );

  // تصدير البيانات إلى JSON (بديل لـ Excel مؤقتاً)
  const exportData = () => {
    try {
      const dataStr = JSON.stringify(behaviorRecords, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `violations_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      showAlertMessage('تم تصدير البيانات بنجاح', 'success');
    } catch (error) {
      showAlertMessage('خطأ في تصدير البيانات', 'error');
    }
  };

  // مكون رسائل التنبيه
  const AlertMessage = () => {
    if (!showAlert) return null;
    
    return (
      <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg border-2 ${
        showAlert.type === 'success' 
          ? 'bg-green-50 text-green-800 border-green-300' 
          : 'bg-red-50 text-red-800 border-red-300'
      }`}>
        <div className="flex items-center gap-2">
          {showAlert.type === 'success' ? 
            <CheckCircle className="h-5 w-5" /> : 
            <XCircle className="h-5 w-5" />
          }
          <span className="font-medium">{showAlert.message}</span>
        </div>
      </div>
    );
  };

  // لوحة التحكم الرئيسية
  const Dashboard = () => {
    const today = new Date().toISOString().split('T')[0];
    const todayViolations = behaviorRecords.filter(record => record.date === today);
    const pendingViolations = behaviorRecords.filter(record => record.status === 'قيد المعالجة');
    const urgentViolations = behaviorRecords.filter(record => record.status === 'يحتاج متابعة');
    const completedViolations = behaviorRecords.filter(record => record.status === 'مكتمل');

    return (
      <div className="space-y-6">
        {/* إحصائيات سريعة */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="bg-white p-6 rounded-lg shadow-md border-r-4 border-green-500">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">اليوم</p>
                <p className="text-2xl font-bold text-green-700">{todayViolations.length}</p>
                <p className="text-xs text-gray-500">مخالفات جديدة</p>
              </div>
              <div className="bg-green-100 p-3 rounded-full">
                <FileText className="h-6 w-6 text-green-600" />
              </div>
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-lg shadow-md border-r-4 border-yellow-500">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">قيد المعالجة</p>
                <p className="text-2xl font-bold text-yellow-700">{pendingViolations.length}</p>
                <p className="text-xs text-gray-500">تحتاج إجراء</p>
              </div>
              <div className="bg-yellow-100 p-3 rounded-full">
                <Clock className="h-6 w-6 text-yellow-600" />
              </div>
            </div>
          </div>

          <div className="bg-white p-6 rounded-lg shadow-md border-r-4 border-red-500">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">تحتاج متابعة</p>
                <p className="text-2xl font-bold text-red-700">{urgentViolations.length}</p>
                <p className="text-xs text-gray-500">حالات خطيرة</p>
              </div>
              <div className="bg-red-100 p-3 rounded-full">
                <AlertTriangle className="h-6 w-6 text-red-600" />
              </div>
            </div>
          </div>

          <div className="bg-white p-6 rounded-lg shadow-md border-r-4 border-blue-500">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">مكتملة</p>
                <p className="text-2xl font-bold text-blue-700">{completedViolations.length}</p>
                <p className="text-xs text-gray-500">تم حلها</p>
              </div>
              <div className="bg-blue-100 p-3 rounded-full">
                <Award className="h-6 w-6 text-blue-600" />
              </div>
            </div>
          </div>
        </div>

        {/* المخالفات الأخيرة */}
        <div className="bg-white rounded-lg shadow-md">
          <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-lg">
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <FileText className="h-5 w-5" />
              آخر المخالفات المسجلة
            </h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="text-right p-4 font-semibold text-gray-700">الطالب</th>
                  <th className="text-right p-4 font-semibold text-gray-700">المخالفة</th>
                  <th className="text-right p-4 font-semibold text-gray-700">المكان</th>
                  <th className="text-right p-4 font-semibold text-gray-700">الدرجة</th>
                  <th className="text-right p-4 font-semibold text-gray-700">الحالة</th>
                  <th className="text-right p-4 font-semibold text-gray-700">الوقت</th>
                </tr>
              </thead>
              <tbody>
                {behaviorRecords.slice(0, 5).map((record) => (
                  <tr key={record.id} className="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td className="p-4">
                      <div>
                        <p className="font-medium text-gray-900">{record.studentName}</p>
                        <p className="text-xs text-gray-500">{record.grade} - فصل {record.section}</p>
                      </div>
                    </td>
                    <td className="p-4">
                      <p className="text-sm max-w-xs truncate" title={record.behavior}>{record.behavior}</p>
                      <span className={`inline-block px-2 py-1 rounded-full text-xs mt-1 font-medium border ${getCategoryColor(record.category)}`}>
                        {record.category}
                      </span>
                    </td>
                    <td className="p-4">
                      <div className="flex items-center gap-2">
                        <MapPin className="h-4 w-4 text-gray-400" />
                        <span className="text-sm">{record.location}</span>
                      </div>
                    </td>
                    <td className="p-4">
                      <span className="font-bold text-red-600 text-lg">-{record.pointsDeducted}</span>
                    </td>
                    <td className="p-4">
                      <span className={`px-3 py-1 rounded-full text-xs font-medium border ${getStatusColor(record.status)}`}>
                        {record.status}
                      </span>
                    </td>
                    <td className="p-4 text-sm">
                      <div>
                        <p>{record.date}</p>
                        <p className="text-xs text-gray-500">{record.time}</p>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // تسجيل مخالفة جديدة
  const NewViolation = () => (
    <div className="space-y-6">
      <div className="bg-white rounded-lg shadow-md overflow-hidden">
        <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6">
          <h4 className="text-xl font-semibold flex items-center gap-2">
            <Plus className="h-5 w-5" />
            تسجيل مخالفة جديدة
          </h4>
          <p className="text-green-100 text-sm mt-1">وفقاً لقواعد تنظيم السلوك والمواظبة المحدثة 1447هـ</p>
        </div>
        
        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* معلومات الطالب */}
            <div className="space-y-4">
              <div className="border-r-4 border-green-500 pr-4">
                <h5 className="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <User className="h-4 w-4" />
                  معلومات الطالب
                </h5>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">
                  اسم الطالب <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={newRecord.studentName}
                  onChange={(e) => setNewRecord({...newRecord, studentName: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                  placeholder="الاسم الثلاثي للطالب"
                  required
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700">
                    الصف <span className="text-red-500">*</span>
                  </label>
                  <select
                    value={newRecord.grade}
                    onChange={(e) => setNewRecord({...newRecord, grade: e.target.value})}
                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                    required
                  >
                    <option value="">اختر الصف</option>
                    <option value="الأول المتوسط">الأول المتوسط</option>
                    <option value="الثاني المتوسط">الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الثالث المتوسط</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700">
                    القسم <span className="text-red-500">*</span>
                  </label>
                  <select
                    value={newRecord.section}
                    onChange={(e) => setNewRecord({...newRecord, section: e.target.value})}
                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                    required
                  >
                    <option value="">اختر القسم</option>
                    {[1,2,3,4,5,6].map(num => (
                      <option key={num} value={num.toString()}>{num}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>

            {/* تفاصيل المخالفة */}
            <div className="space-y-4">
              <div className="border-r-4 border-red-500 pr-4">
                <h5 className="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <AlertTriangle className="h-4 w-4" />
                  تفاصيل المخالفة
                </h5>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">
                  مكان المخالفة <span className="text-red-500">*</span>
                </label>
                <select
                  value={newRecord.location}
                  onChange={(e) => setNewRecord({...newRecord, location: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                  required
                >
                  <option value="">اختر المكان</option>
                  {schoolLocations.map((location) => (
                    <option key={location.id} value={location.name}>
                      {location.name}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">وقت المخالفة</label>
                <input
                  type="time"
                  value={newRecord.time}
                  onChange={(e) => setNewRecord({...newRecord, time: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">
                  نوع المخالفة <span className="text-red-500">*</span>
                </label>
                <select
                  value={newRecord.rule}
                  onChange={(e) => handleRuleChange(e.target.value)}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                  required
                >
                  <option value="">اختر المخالفة</option>
                  {Object.entries(behaviorRules).map(([key, rules]) => (
                    <optgroup key={key} label={rules[0]?.category?.replace('الدرجة', 'مخالفات الدرجة') || key}>
                      {rules.map((rule, index) => (
                        <option key={index} value={rule.rule}>
                          {rule.rule} {rule.points > 0 ? `(${rule.points} ${rule.points === 1 ? 'درجة' : 'درجات'})` : ''}
                        </option>
                      ))}
                    </optgroup>
                  ))}
                </select>
              </div>
              
              {/* إدخال الدرجة المخصومة عند اختيار "أخرى" */}
              {newRecord.rule === 'أخرى' && (
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700">
                    الدرجة المخصومة <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="number"
                    value={newRecord.customPoints}
                    onChange={(e) => setNewRecord({...newRecord, customPoints: e.target.value, pointsDeducted: parseInt(e.target.value) || 0})}
                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                    placeholder="أدخل عدد الدرجات"
                    min="0"
                    max="15"
                  />
                </div>
              )}
              
              {newRecord.pointsDeducted > 0 && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="text-center">
                    <span className="text-2xl font-bold text-red-600">
                      -{newRecord.pointsDeducted} {newRecord.pointsDeducted === 1 ? 'درجة' : 'درجات'}
                    </span>
                    <p className="text-sm text-red-500 mt-1">مخصومة من درجة السلوك</p>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* وصف المخالفة والإجراءات */}
          <div className="mt-8 space-y-6">
            <div>
              <label className="block text-sm font-medium mb-2 text-gray-700">
                وصف تفصيلي للمخالفة <span className="text-red-500">*</span>
              </label>
              <textarea
                value={newRecord.behavior}
                onChange={(e) => setNewRecord({...newRecord, behavior: e.target.value})}
                className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                rows="4"
                placeholder="اكتب وصف مفصل للمخالفة التي حدثت..."
                required
              />
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">
                  الإجراء المتخذ <span className="text-red-500">*</span>
                </label>
                <select
                  value={newRecord.action}
                  onChange={(e) => setNewRecord({...newRecord, action: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                  required
                >
                  <option value="">اختر الإجراء</option>
                  <option value="تنبيه شفهي">تنبيه شفهي</option>
                  <option value="تنبيه شفهي + تسجيل في النظام">تنبيه شفهي + تسجيل</option>
                  <option value="إشعار ولي الأمر هاتفياً">إشعار ولي الأمر هاتفياً</option>
                  <option value="إشعار ولي الأمر + تعهد خطي">إشعار ولي الأمر + تعهد</option>
                  <option value="إحالة للمرشد الطلابي">إحالة للمرشد الطلابي</option>
                  <option value="إحالة للمدير">إحالة للمدير</option>
                  <option value="استدعاء ولي الأمر">استدعاء ولي الأمر</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">العمل الإيجابي للتعويض</label>
                <select
                  value={newRecord.positiveAction}
                  onChange={(e) => setNewRecord({...newRecord, positiveAction: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                >
                  <option value="">اختر العمل الإيجابي</option>
                  {compensationOptions.map((option, index) => (
                    <option key={index} value={option}>
                      {option}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* حقل العمل الإيجابي المخصص */}
            {newRecord.positiveAction === 'أخرى' && (
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700">اكتب العمل الإيجابي المخصص</label>
                <textarea
                  value={newRecord.customPositiveAction}
                  onChange={(e) => setNewRecord({...newRecord, customPositiveAction: e.target.value})}
                  className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                  rows="2"
                  placeholder="اكتب تفاصيل العمل الإيجابي المقترح..."
                />
              </div>
            )}

            <div>
              <label className="block text-sm font-medium mb-2 text-gray-700">الشهود</label>
              <input
                type="text"
                value={newRecord.witnesses}
                onChange={(e) => setNewRecord({...newRecord, witnesses: e.target.value})}
                className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-right focus:border-green-500 focus:outline-none transition-colors"
                placeholder="أسماء الشهود (اختياري)"
              />
            </div>
          </div>

          {/* أزرار الحفظ */}
          <div className="flex gap-4 mt-8 pt-6 border-t border-gray-200">
            <button
              onClick={handleAddRecord}
              className="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center gap-2 shadow-md"
            >
              <Save className="h-5 w-5" />
              حفظ المخالفة
            </button>
            <button
              onClick={() => setNewRecord({
                studentName: '',
                grade: '',
                section: '',
                behavior: '',
                location: '',
                rule: '',
                category: '',
                pointsDeducted: 0,
                customPoints: '',
                action: '',
                positiveAction: '',
                customPositiveAction: '',
                witnesses: '',
                time: ''
              })}
              className="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-md"
            >
              إعادة تعيين
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  // جميع المخالفات
  const AllViolations = () => (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <h3 className="text-xl font-semibold text-gray-800">جميع المخالفات المسجلة</h3>
        <div className="flex gap-2">
          <div className="relative">
            <Search className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <input
              type="text"
              placeholder="البحث في المخالفات..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pr-10 pl-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors"
            />
          </div>
          <button 
            onClick={exportData}
            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md transition-colors"
          >
            <Download className="h-4 w-4" />
            تصدير البيانات
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow-md overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gradient-to-r from-green-600 to-green-700 text-white">
              <tr>
                <th className="text-right p-4 font-semibold">رقم</th>
                <th className="text-right p-4 font-semibold">الطالب</th>
                <th className="text-right p-4 font-semibold">المخالفة</th>
                <th className="text-right p-4 font-semibold">المكان</th>
                <th className="text-right p-4 font-semibold">الدرجة</th>
                <th className="text-right p-4 font-semibold">الإجراء</th>
                <th className="text-right p-4 font-semibold">الحالة</th>
                <th className="text-right p-4 font-semibold">التاريخ</th>
                <th className="text-right p-4 font-semibold">عمليات</th>
              </tr>
            </thead>
            <tbody>
              {filteredRecords.map((record) => (
                <tr key={record.id} className="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                  <td className="p-4 font-medium text-green-700">#{record.id}</td>
                  <td className="p-4">
                    <div>
                      <p className="font-medium text-gray-900">{record.studentName}</p>
                      <p className="text-xs text-gray-500">{record.grade} - فصل {record.section}</p>
                    </div>
                  </td>
                  <td className="p-4">
                    <div>
                      <p className="text-sm max-w-xs" title={record.behavior}>{record.behavior}</p>
                      <span className={`inline-block px-2 py-1 rounded-full text-xs mt-1 font-medium border ${getCategoryColor(record.category)}`}>
                        {record.category}
                      </span>
                    </div>
                  </td>
                  <td className="p-4">
                    <div className="flex items-center gap-2">
                      <MapPin className="h-4 w-4 text-gray-400" />
                      <span className="text-sm">{record.location}</span>
                    </div>
                  </td>
                  <td className="p-4">
                    <span className="font-bold text-red-600 text-lg">-{record.pointsDeducted}</span>
                  </td>
                  <td className="p-4">
                    <p className="text-sm max-w-xs truncate" title={record.action}>{record.action}</p>
                  </td>
                  <td className="p-4">
                    <select
                      value={record.status}
                      onChange={(e) => updateStatus(record.id, e.target.value)}
                      className={`px-3 py-1 rounded-full text-xs font-medium border cursor-pointer ${getStatusColor(record.status)}`}
                    >
                      <option value="قيد المعالجة">قيد المعالجة</option>
                      <option value="يحتاج متابعة">يحتاج متابعة</option>
                      <option value="مكتمل">مكتمل</option>
                    </select>
                  </td>
                  <td className="p-4 text-sm">
                    <div>
                      <p>{record.date}</p>
                      <p className="text-xs text-gray-500">{record.time}</p>
                    </div>
                  </td>
                  <td className="p-4">
                    <div className="flex gap-1">
                      <button 
                        className="text-green-600 hover:text-green-800 p-2 rounded transition-colors"
                        title="عرض التفاصيل"
                        onClick={() => showAlertMessage('عرض التفاصيل قريباً', 'success')}
                      >
                        <Eye className="h-4 w-4" />
                      </button>
                      <button 
                        className="text-blue-600 hover:text-blue-800 p-2 rounded transition-colors"
                        title="تعديل"
                        onClick={() => showAlertMessage('التعديل قريباً', 'success')}
                      >
                        <Edit className="h-4 w-4" />
                      </button>
                      <button 
                        className="text-purple-600 hover:text-purple-800 p-2 rounded transition-colors"
                        title="طباعة"
                        onClick={() => showAlertMessage('الطباعة قريباً', 'success')}
                      >
                        <Download className="h-4 w-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          
          {filteredRecords.length === 0 && (
            <div className="text-center py-8">
              <p className="text-gray-500">لا توجد مخالفات مطابقة لمعايير البحث</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  // التقارير والإحصائيات
  const Reports = () => {
    const categoryStats = {
      'الدرجة الأولى': behaviorRecords.filter(r => r.category === 'الدرجة الأولى').length,
      'الدرجة الثانية': behaviorRecords.filter(r => r.category === 'الدرجة الثانية').length,
      'الدرجة الثالثة': behaviorRecords.filter(r => r.category === 'الدرجة الثالثة').length,
      'الدرجة الرابعة': behaviorRecords.filter(r => r.category === 'الدرجة الرابعة').length,
      'الدرجة الخامسة': behaviorRecords.filter(r => r.category === 'الدرجة الخامسة').length,
    };
    
    const locationStats = schoolLocations.map(loc => ({
      name: loc.name,
      count: behaviorRecords.filter(r => r.location === loc.name).length
    })).sort((a, b) => b.count - a.count);

    return (
      <div className="space-y-6">
        <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-lg shadow-md">
          <h3 className="text-xl font-semibold flex items-center gap-2">
            <BarChart3 className="h-6 w-6" />
            التقارير والإحصائيات
          </h3>
          <p className="text-green-100 text-sm mt-1">تحليل شامل لسلوك الطلاب والاتجاهات</p>
        </div>
        
        {/* إحصائيات المخالفات حسب الدرجة */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white rounded-lg shadow-md p-6">
            <h4 className="font-semibold mb-6 text-gray-700 flex items-center gap-2">
              <BarChart3 className="h-5 w-5 text-green-600" />
              توزيع المخالفات حسب الدرجة
            </h4>
            <div className="space-y-4">
              {Object.entries(categoryStats).map(([category, count]) => {
                const maxCount = Math.max(...Object.values(categoryStats));
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const colors = {
                  'الدرجة الأولى': 'blue',
                  'الدرجة الثانية': 'green', 
                  'الدرجة الثالثة': 'yellow',
                  'الدرجة الرابعة': 'orange',
                  'الدرجة الخامسة': 'red'
                };
                const color = colors[category];
                
                return (
                  <div key={category} className={`flex justify-between items-center p-4 bg-${color}-50 rounded-lg border border-${color}-200`}>
                    <span className={`font-medium text-${color}-800`}>{category}</span>
                    <div className="flex items-center gap-3">
                      <div className={`w-24 bg-${color}-200 rounded-full h-3`}>
                        <div className={`bg-${color}-500 h-3 rounded-full`} style={{width: `${percentage}%`}}></div>
                      </div>
                      <span className={`text-lg font-bold text-${color}-700`}>{count}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-6">
            <h4 className="font-semibold mb-6 text-gray-700 flex items-center gap-2">
              <MapPin className="h-5 w-5 text-red-600" />
              أكثر الأماكن مخالفة
            </h4>
            <div className="space-y-4">
              {locationStats.slice(0, 5).map((location, index) => {
                const maxCount = locationStats[0]?.count || 1;
                const percentage = (location.count / maxCount) * 100;
                const colors = ['red', 'orange', 'yellow', 'blue', 'green'];
                const color = colors[index] || 'gray';
                
                return (
                  <div key={location.name} className="flex justify-between items-center p-3 rounded-lg bg-gray-50">
                    <span className="text-sm font-medium">{location.name}</span>
                    <div className="flex items-center gap-3">
                      <div className="w-20 bg-gray-200 rounded-full h-2">
                        <div className={`bg-${color}-500 h-2 rounded-full`} style={{width: `${percentage}%`}}></div>
                      </div>
                      <span className={`text-sm font-bold text-${color}-600`}>{location.count}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* معلومات إضافية */}
        <div className="bg-white rounded-lg shadow-md p-6">
          <h4 className="font-semibold mb-4 text-green-700 flex items-center gap-2">
            <Award className="h-5 w-5" />
            ملخص إحصائي
          </h4>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="text-center p-4 bg-green-50 rounded-lg border border-green-200">
              <p className="text-2xl font-bold text-green-700">{behaviorRecords.length}</p>
              <p className="text-sm text-green-600">إجمالي المخالفات</p>
            </div>
            <div className="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-2xl font-bold text-blue-700">
                {behaviorRecords.reduce((sum, record) => sum + record.pointsDeducted, 0)}
              </p>
              <p className="text-sm text-blue-600">إجمالي الدرجات المخصومة</p>
            </div>
            <div className="text-center p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p className="text-2xl font-bold text-purple-700">
                {[...new Set(behaviorRecords.map(r => r.studentName))].length}
              </p>
              <p className="text-sm text-purple-600">عدد الطلاب المخالفين</p>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 rtl" dir="rtl">
      <AlertMessage />
      
      {/* الهيدر الرسمي */}
      <div className="bg-white shadow-lg border-b-4 border-green-600">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between py-4">
            <div className="flex items-center gap-4">
              <div className="bg-green-600 text-white p-3 rounded-lg shadow-md">
                <Shield className="h-8 w-8" />
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-600 font-medium">المملكة العربية السعودية</p>
                <p className="text-lg font-bold text-green-700">وزارة التعليم</p>
                <p className="text-md font-semibold text-gray-800">متوسطة المنذر بن عمرو الأنصاري</p>
                <p className="text-sm text-green-600 font-medium">منصة الوكيل ١٤٤٧</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <div className="text-right">
                <p className="text-lg font-bold text-gray-900">نواف الصبحي</p>
                <p className="text-sm text-gray-600">وكيل المدرسة</p>
              </div>
              <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center shadow-md">
                <User className="h-7 w-7 text-green-600" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* القائمة الرئيسية */}
        <div className="mb-8">
          <nav className="flex space-x-reverse space-x-8 bg-white rounded-lg shadow-md p-2">
            <button
              onClick={() => setActiveSection('dashboard')}
              className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                activeSection === 'dashboard'
                  ? 'bg-green-100 text-green-700 border-2 border-green-600 shadow-md'
                  : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-2">
                <BarChart3 className="h-5 w-5" />
                لوحة التحكم
              </div>
            </button>
            <button
              onClick={() => setActiveSection('new')}
              className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                activeSection === 'new'
                  ? 'bg-blue-100 text-blue-700 border-2 border-blue-600 shadow-md'
                  : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-2">
                <Plus className="h-5 w-5" />
                تسجيل مخالفة
              </div>
            </button>
            <button
              onClick={() => setActiveSection('all')}
              className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                activeSection === 'all'
                  ? 'bg-purple-100 text-purple-700 border-2 border-purple-600 shadow-md'
                  : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-2">
                <FileText className="h-5 w-5" />
                جميع المخالفات
              </div>
            </button>
            <button
              onClick={() => setActiveSection('reports')}
              className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                activeSection === 'reports'
                  ? 'bg-orange-100 text-orange-700 border-2 border-orange-600 shadow-md'
                  : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
              }`}
            >
              <div className="flex items-center gap-2">
                <Award className="h-5 w-5" />
                التقارير
              </div>
            </button>
          </nav>
        </div>

        {/* المحتوى الرئيسي */}
        {activeSection === 'dashboard' && <Dashboard />}
        {activeSection === 'new' && <NewViolation />}
        {activeSection === 'all' && <AllViolations />}
        {activeSection === 'reports' && <Reports />}

        {/* الفوتر */}
        <div className="mt-12 bg-white rounded-lg shadow-md p-6">
          <div className="text-center space-y-2">
            <p className="text-sm text-gray-600">© 2025 منصة الوكيل لإدارة السلوك الطلابي</p>
            <p className="text-sm text-gray-500">متوسطة المنذر بن عمرو الأنصاري - المملكة العربية السعودية</p>
            <div className="flex justify-center items-center gap-4 text-xs text-gray-400 pt-2 border-t border-gray-200 mt-4">
              <span>نسخة محسنة مع حفظ البيانات محلياً</span>
              <span>|</span>
              <span>إعداد: نواف الصبحي - 2025</span>
            </div>
            <div className="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p className="text-xs text-yellow-700">
                <strong>تنبيه:</strong> البيانات محفوظة محلياً في المتصفح. للاستخدام الفعلي، يُنصح بإنشاء قاعدة بيانات خارجية ونظام نسخ احتياطي.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ViceDirectorPlatform;
