<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://*.firebaseio.com; object-src 'none'; base-uri 'none';">
  <title>نافس - مسابقة متوسطة المنذر بن عمرو الأنصاري</title>

  <!-- Preload critical CSS -->
  <link rel="preload" href="data:text/css;base64,Lyo9PT09PT09PT09PT09PT09PT0gUm9vdCBWYXJpYWJsZXMgPT09PT09PT09PT09PT09PT09PSovIDpSb290ey0tcHJpbWFyeTojNjM2NmYxOyAtLXN1Y2Nlc3M6IzEwYjk4MTsgLS1kYW5nZXI6I2VmNDQ0NDsgLXItcmFkaXVzOjI1cHg7IC0tc2hhZG93OjAgMTVweCA0MHB4IHJnYmEoOTksMTAyLDI0MSwuMTUpfSAvKj09PT09PT09PT09PT09PT09PSBCYXNlID09PT09PT09PT09PT09PT09PT0qLyAqeyBtYXJnaW46MDsgcGFkZGluZzowOyBib3gtc2l6aW5nOmJvcmRlci1ib3ggfSBodG1sLGJvZHl7IGRpcmVjdGlvbjpydGwsgZGlzcGxheTpmbGV4OyBmbGV4LWRpcmVjdGlvbjpjb2x1bW47IG1pbmgtaGVpZ2h0OjEwMHZofSBib2R5eyBmb250LWZhbWlseTonU2Vnb2UgVUknLFRhaG9tYSxHZW5ldmEsVmVyZGFuYSxzYW5zLXNlcmlmOyBiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxMzVkZWcsIzY2N2VlYSAwJSwjNzY0YmEyIDEwMCUpOyB1c2VyLXNlbGVjdDpub25lOyBvdmVyZmxvdy14OmhpZGRlbiB9IC5oaWRkZW57IGRpc3BsYXk6bm9uZSFpbXBvcnRhbnQgfQ==" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><style>/* inlined critical css */</style></noscript>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <style>
    /* ======== Critical CSS inlined ======== */
    .quiz-container{max-width:900px;margin:0 auto;padding:20px}
    .header{background:rgba(255,255,255,.98);border-radius:var(--radius);padding:30px;margin-bottom:25px;text-align:center;box-shadow:var(--shadow)}
    .quiz-title{font-size:3em;font-weight:900;background:linear-gradient(135deg,var(--primary),#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .question-card{background:rgba(255,255,255,.98);border-radius:30px;padding:50px;margin-bottom:30px;box-shadow:var(--shadow)}
    .btn{background:linear-gradient(135deg,var(--primary),#4f46e5);color:#fff;border:none;padding:20px 45px;border-radius:30px;font-size:1.2em;font-weight:700;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:1px;min-width:200px}
    .btn:disabled{background:linear-gradient(135deg,#9ca3af,#6b7280);cursor:not-allowed}
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(5px)}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.3)}
    .loading-spinner{width:60px;height:60px;border:6px solid #f3f4f6;border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>جاري تحضير المسابقة...</h3>
      <p>يرجى الانتظار قليلاً</p>
    </div>
  </div>

  <!-- Save Confirmation Modal -->
  <div class="loading-overlay hidden" id="saveConfirmation">
    <div class="save-confirmation">
      <h3>💾 حفظ التقدم والخروج</h3>
      <p>هل تريد حفظ تقدمك الحالي والخروج من المسابقة؟<br>
      <strong>سيتم حفظ:</strong><br>
      ✅ السؤال الحالي ونقاطك<br>
      ✅ إجاباتك السابقة<br>
      ✅ الوقت المتبقي<br><br>
      يمكنك العودة لاحقاً واستكمال من نفس النقطة.</p>
      <div class="action-buttons">
        <button class="btn btn-save" id="confirmSaveBtn">✅ نعم، احفظ واخرج</button>
        <button class="btn btn-secondary" id="cancelSaveBtn">❌ إلغاء والمتابعة</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="quiz-container">
    <div class="header">
      <div class="ministry-info">وزارة التعليم • متوسطة المنذر بن عمرو الأنصاري</div>
      <h1 class="quiz-title">🏆 مسابقة نافس التفاعلية</h1>
      <div class="student-info">
        <span id="studentIcon">👤</span>
        <strong>الطالب:</strong> <span id="studentName">أحمد محمد</span> • 
        <strong>الصف:</strong> <span id="studentGrade">الثالث المتوسط</span> • 
        <span id="studentSection">الشعبة أ</span>
      </div>
    </div>

    <div class="progress-section">
      <div class="progress-header">
        <div class="question-counter" id="questionCounter">السؤال 1 من 10</div>
        <div class="timer-container">
          <div class="timer" id="timer">⏰ 60</div>
          <div class="score-display" id="scoreDisplay">النقاط: 0</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:10%"></div>
      </div>
      <div class="progress-text" id="progressText">تقدمك: 10% • المتبقي: 9 أسئلة</div>
    </div>

    <div class="question-card" id="questionCard">
      <div class="question-header">
        <div class="question-icon">🤔</div>
        <div>
          <div class="question-category" id="questionCategory">الرياضيات</div>
          <div class="question-difficulty" id="questionDifficulty">⭐⭐ متوسط</div>
        </div>
      </div>
      <div class="question-text" id="questionText">جاري تحميل السؤال...</div>
      <div class="options-container" id="optionsContainer"></div>
      <div class="message-container" id="messageContainer"></div>
      <div class="action-buttons">
        <button class="btn" id="submitBtn" disabled>✅ تأكيد الإجابة</button>
        <button class="btn hidden" id="nextBtn">⏭️ السؤال التالي</button>
        <button class="btn btn-warning" id="skipBtn">⏭️ تخطي السؤال</button>
        <button class="btn btn-save" id="saveExitBtn">💾 حفظ وخروج</button>
      </div>
    </div>

    <div class="completion-card hidden" id="completionCard">
      <h2>🎉 تهانينا! لقد أكملت المسابقة</h2>
      <div class="final-score" id="finalScore">0/100</div>
      <p>🌟 أداء رائع! سيتم توجيهك إلى لوحة النتائج...</p>
    </div>

    <div class="footer-credit">
      <div class="supervisor">تصميم وتنفيذ: نواف الصبحي</div>
      <div class="school">متوسطة المنذر بن عمرو الأنصاري</div>
    </div>
  </div>

  <script>
    /* ========== Security First ========== */
    window.eval = null;
    window.open = null;
    console.clear = () => {};
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase()))) {
        e.preventDefault();
      }
    });
  </script>

  <!-- Core Module -->
  <script type="module">
    // ============== Firebase Config ==============
    const firebaseConfig = {
      apiKey: "AIzaSyA5yepZwrOlqFiV_KkVHp9dBaaT65pgdRo",
      authDomain: "nafs-competition.firebaseapp.com",
      projectId: "nafs-competition",
      storageBucket: "nafs-competition.firebasestorage.app",
      messagingSenderId: "182205828634",
      appId: "1:182205828634:web:dee889f770eb52ff668ba3"
    };

    // ============== Conditional Firebase Import ==============
    let db = null, auth = null;
    if (navigator.onLine) {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { getFirestore, doc, setDoc, updateDoc, query, where, getDocs, orderBy, limit, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log('✅ Firebase modules loaded');
      } catch (e) {
        console.warn('⚠️ Firebase failed, running offline');
      }
    }

    // ============== SafeStorage ==============
    const SafeStorage = {
      _memory: {},
      setItem(k, v) {
        try { if (typeof sessionStorage !== 'undefined') sessionStorage.setItem(k, v); else this._memory[k] = v; return true; } catch { this._memory[k] = v; }
      },
      getItem(k) {
        try { if (typeof sessionStorage !== 'undefined') return sessionStorage.getItem(k); } catch {} return this._memory[k] || null;
      },
      removeItem(k) {
        try { if (typeof sessionStorage !== 'undefined') sessionStorage.removeItem(k); } catch {} delete this._memory[k];
      }
    };

    // ============== AppState ==============
    const AppState = {
      currentQuestionIndex: 0,
      selectedAnswer: null,
      score: 0,
      timeLeft: 60,
      timerInterval: null,
      sessionCompleted: false,
      questionStartTime: Date.now(),
      currentQuestions: [],
      studentData: null,
      sessionId: null,
      isPaused: false,
      isSubmitting: false
    };

    // ============== SessionManager ==============
    class SessionManager {
      constructor() { this.studentData = null; this.isSessionValid = false; this.sessionTimeout = 7 * 24 * 60 * 60 * 1000; }
      validateSession() {
        const saved = SafeStorage.getItem('nafes_student_data');
        if (!saved) return false;
        try {
          this.studentData = JSON.parse(saved);
          if (!this.studentData?.studentId || !this.studentData?.fullName) return false;
          if (Date.now() - (this.studentData.timestamp || 0) > this.sessionTimeout) { this.clearSession(); return false; }
          this.isSessionValid = true;
          AppState.studentData = this.studentData;
          return true;
        } catch { this.clearSession(); return false; }
      }
      updateStudentDisplay() {
        if (!this.studentData) return;
        document.getElementById('studentName').textContent = this.studentData.fullName;
        document.getElementById('studentGrade').textContent = this.studentData.grade;
        document.getElementById('studentSection').textContent = `الشعبة ${this.studentData.section}`;
        document.getElementById('studentIcon').textContent = this.studentData.icon;
      }
      saveQuizProgress(progress) {
        try {
          const data = { ...progress, studentId: this.studentData.studentId, timestamp: Date.now() };
          SafeStorage.setItem('nafes_quiz_progress', JSON.stringify(data));
          return true;
        } catch { return false; }
      }
      loadQuizProgress() {
        try {
          const saved = SafeStorage.getItem('nafes_quiz_progress');
          if (!saved) return null;
          const progress = JSON.parse(saved);
          if (progress.studentId !== this.studentData.studentId) return null;
          if (Date.now() - (progress.timestamp || 0) > this.sessionTimeout) { this.clearQuizProgress(); return null; }
          return progress;
        } catch { this.clearQuizProgress(); return null; }
      }
      clearQuizProgress() { SafeStorage.removeItem('nafes_quiz_progress'); }
      clearSession() { SafeStorage.removeItem('nafes_student_data'); SafeStorage.removeItem('nafes_quiz_progress'); this.studentData = null; this.isSessionValid = false; }
    }

    // ============== QuestionManager ==============
    class QuestionManager {
      constructor() { this.questions = []; }
      async loadQuestions() {
        console.log('🔄 Loading questions...');
        if (db) {
          try {
            const q = query(collection(db, 'questions'), where('isActive', '==', true), limit(10));
            const snap = await getDocs(q);
            if (!snap.empty) {
              this.questions = [];
              snap.forEach(doc => { const d = doc.data(); this.questions.push({ id: doc.id, category: d.category, difficulty: d.difficulty, text: d.text, options: d.options, correct: d.correct, points: d.points || 10 }); });
              this.questions = this.shuffleArray(this.questions);
              console.log('✅ Firebase questions loaded'); return;
            }
          } catch (e) { console.warn('⚠️ Firebase failed, fallback to local'); }
        }
        this.questions = this.getLocalQuestions(); this.questions = this.shuffleArray(this.questions);
        console.log('✅ Local questions loaded');
      }
      getLocalQuestions() {
        return [
          { id: "local_1", category: "الرياضيات", difficulty: "متوسط", text: "ما ناتج 15 + 27؟", options: ["40", "42", "45", "38"], correct: 1, points: 10 },
          { id: "local_2", category: "العلوم", difficulty: "سهل", text: "كم عدد كواكب المجموعة الشمسية؟", options: ["7", "8", "9", "10"], correct: 1, points: 10 },
          { id: "local_3", category: "التاريخ", difficulty: "متوسط", text: "في أي عام تأسست المملكة العربية السعودية؟", options: ["1930", "1932", "1935", "1940"], correct: 1, points: 10 },
          { id: "local_4", category: "اللغة العربية", difficulty: "سهل", text: "ما إعراب كلمة 'محمد' في جملة 'جاء محمد'؟", options: ["مبتدأ", "فاعل", "مفعول به", "خبر"], correct: 1, points: 10 },
          { id: "local_5", category: "الجغرافيا", difficulty: "متوسط", text: "ما هي عاصمة المملكة العربية السعودية؟", options: ["جدة", "الدمام", "الرياض", "مكة"], correct: 2, points: 10 },
          { id: "local_6", category: "الرياضيات", difficulty: "صعب", text: "ما ناتج 12 × 15؟", options: ["170", "180", "185", "190"], correct: 1, points: 15 },
          { id: "local_7", category: "العلوم", difficulty: "متوسط", text: "ما هو الغاز الأكثر انتشاراً في الغلاف الجوي؟", options: ["الأكسجين", "النيتروجين", "ثاني أكسيد الكربون", "الهيدروجين"], correct: 1, points: 10 },
          { id: "local_8", category: "الدين", difficulty: "سهل", text: "كم عدد أركان الإسلام؟", options: ["4", "5", "6", "7"], correct: 1, points: 10 },
          { id: "local_9", category: "التاريخ", difficulty: "صعب", text: "من هو مؤسس الدولة السعودية الأولى؟", options: ["محمد بن سعود", "عبدالعزيز آل سعود", "تركي بن عبدالله", "فيصل بن تركي"], correct: 0, points: 15 },
          { id: "local_10", category: "اللغة العربية", difficulty: "متوسط", text: "ما معنى كلمة 'صبر' في اللغة العربية؟", options: ["التحمل", "السرعة", "القوة", "الحكمة"], correct: 0, points: 10 }
        ];
      }
      shuffleArray(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
      getCurrentQuestion() { return this.questions[AppState.currentQuestionIndex]; }
      getTotalQuestions() { return this.questions.length; }
    }

    // ============== TimerManager ==============
    class TimerManager {
      constructor() { this.timerElement = document.getElementById('timer'); }
      start() {
        this.stop();
        AppState.timerInterval = setInterval(() => {
          if (!AppState.isPaused) {
            AppState.timeLeft--;
            this.updateDisplay();
            if (AppState.timeLeft <= 0) { this.stop(); quizController.handleTimeUp(); }
          }
        }, 1000);
      }
      stop() { if (AppState.timerInterval) { clearInterval(AppState.timerInterval); AppState.timerInterval = null; } }
      updateDisplay() {
        if (!this.timerElement) return;
        this.timerElement.textContent = `⏰ ${AppState.timeLeft}`;
        this.timerElement.className = 'timer';
        if (AppState.timeLeft <= 10) this.timerElement.classList.add('critical');
        else if (AppState.timeLeft <= 20) this.timerElement.classList.add('warning');
      }
      reset(seconds = 60) {
        AppState.timeLeft = seconds;
        this.timerElement.classList.remove('warning', 'critical');
        this.updateDisplay();
      }
    }

    // ============== UIManager ==============
    class UIManager {
      constructor() {
        this.elements = {
          questionCounter: document.getElementById('questionCounter'),
          questionCategory: document.getElementById('questionCategory'),
          questionDifficulty: document.getElementById('questionDifficulty'),
          questionText: document.getElementById('questionText'),
          optionsContainer: document.getElementById('optionsContainer'),
          progressFill: document.getElementById('progressFill'),
          progressText: document.getElementById('progressText'),
          scoreDisplay: document.getElementById('scoreDisplay'),
          messageContainer: document.getElementById('messageContainer'),
          submitBtn: document.getElementById('submitBtn'),
          nextBtn: document.getElementById('nextBtn'),
          skipBtn: document.getElementById('skipBtn'),
          saveExitBtn: document.getElementById('saveExitBtn'),
          questionCard: document.getElementById('questionCard'),
          completionCard: document.getElementById('completionCard'),
          finalScore: document.getElementById('finalScore')
        };
      }
      showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
      showSaveConfirmation() { document.getElementById('saveConfirmation').classList.remove('hidden'); }
      hideSaveConfirmation() { document.getElementById('saveConfirmation').classList.add('hidden'); }
      loadQuestion(question, idx, total) {
        if (!question) return;
        if (this.elements.questionCounter) this.elements.questionCounter.textContent = `السؤال ${idx + 1} من ${total}`;
        if (this.elements.questionCategory) this.elements.questionCategory.textContent = question.category || 'عام';
        if (this.elements.questionDifficulty) this.elements.questionDifficulty.innerHTML = this.getDifficultyStars(question.difficulty) + ' ' + question.difficulty;
        if (this.elements.questionText) this.elements.questionText.textContent = question.text;
        this.loadOptions(question);
        this.resetQuestionState();
        this.updateProgress(idx, total);
        this.updateScoreDisplay();
      }
      loadOptions(question) {
        if (!this.elements.optionsContainer) return;
        this.elements.optionsContainer.innerHTML = '';
        const letters = ['أ', 'ب', 'ج', 'د'];
        question.options.forEach((opt, i) => {
          const div = document.createElement('div');
          div.className = 'option';
          div.dataset.index = i;
          div.innerHTML = `<div class="option-letter">${letters[i]}</div><div class="option-text">${opt}</div>`;
          div.style.opacity = '0';
          div.style.transform = 'translateY(20px)';
          this.elements.optionsContainer.appendChild(div);
          setTimeout(() => {
            div.style.transition = 'all 0.6s ease';
            div.style.opacity = '1';
            div.style.transform = 'translateY(0)';
          }, i * 100);
        });
      }
      updateProgress(current, total) {
        const progress = ((current + 1) / total) * 100;
        if (this.elements.progressFill) this.elements.progressFill.style.width = `${progress}%`;
        if (this.elements.progressText) this.elements.progressText.textContent = `تقدمك: ${Math.round(progress)}% • المتبقي: ${total - current - 1} سؤال`;
      }
      updateScoreDisplay() { if (this.elements.scoreDisplay) this.elements.scoreDisplay.textContent = `النقاط: ${AppState.score}`; }
      resetQuestionState() {
        AppState.selectedAnswer = null;
        AppState.isPaused = false;
        if (this.elements.submitBtn) {
          this.elements.submitBtn.disabled = true;
          this.elements.submitBtn.classList.remove('hidden');
        }
        if (this.elements.nextBtn) this.elements.nextBtn.classList.add('hidden');
        if (this.elements.skipBtn) this.elements.skipBtn.classList.remove('hidden');
        if (this.elements.saveExitBtn) this.elements.saveExitBtn.classList.remove('hidden');
        if (this.elements.messageContainer) this.elements.messageContainer.innerHTML = '';
        document.querySelectorAll('.option').forEach(opt => {
          opt.classList.remove('selected', 'correct', 'incorrect');
          opt.style.pointerEvents = 'auto';
        });
      }
      selectAnswer(optionElement) {
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
        AppState.selectedAnswer = parseInt(optionElement.dataset.index);
        if (this.elements.submitBtn) this.elements.submitBtn.disabled = false;
      }
      showAnswerResults(question, isCorrect) {
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          if (idx === AppState.selectedAnswer && !isCorrect) opt.classList.add('incorrect');
        });
      }
      updateControlButtons() {
        if (this.elements.submitBtn) this.elements.submitBtn.classList.add('hidden');
        if (this.elements.skipBtn) this.elements.skipBtn.classList.add('hidden');
        if (this.elements.saveExitBtn) this.elements.saveExitBtn.classList.add('hidden');
        if (this.elements.nextBtn) this.elements.nextBtn.classList.remove('hidden');
      }
      showMessage(type, text) {
        if (this.elements.messageContainer) this.elements.messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
      }
      showCompletionCard() {
        const total = AppState.currentQuestions.reduce((s, q) => s + (q.points || 10), 0);
        if (this.elements.finalScore) this.elements.finalScore.textContent = `${AppState.score}/${total}`;
        if (this.elements.completionCard) this.elements.completionCard.classList.remove('hidden');
        if (this.elements.questionCard) this.elements.questionCard.classList.add('hidden');
      }
      getDifficultyStars(difficulty) { return difficulty === 'سهل' ? '⭐' : difficulty === 'صعب' ? '⭐⭐⭐' : '⭐⭐'; }
    }

    // ============== QuizController ==============
    class QuizController {
      constructor() {
        this.sessionManager = new SessionManager();
        this.questionManager = new QuestionManager();
        this.timerManager = new TimerManager();
        this.uiManager = new UIManager();
      }
      async start() {
        try {
          this.uiManager.showLoading(true);
          if (!this.sessionManager.validateSession()) { window.location.href = 'index.html'; return; }
          this.sessionManager.updateStudentDisplay();

          if (db && auth) await signInAnonymously(auth);

          await this.questionManager.loadQuestions();
          AppState.currentQuestions = this.questionManager.questions;

          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('resume')) await this.restoreLastSession();
          else await this.checkExistingProgress();

          this.setupEventListeners();
          this.setupSecurity();

          if (!AppState.sessionCompleted) {
            this.loadCurrentQuestion();
            this.timerManager.start();
          }

          this.uiManager.showLoading(false);
          this.uiManager.showMessage('success', '🚀 تم تحضير المسابقة بنجاح! ابدأ الآن');
        } catch (error) {
          console.error('❌ Initialization failed:', error);
          this.uiManager.showLoading(false);
          this.showFallback();
        }
      }
      async restoreLastSession() {
        const progress = this.sessionManager.loadQuizProgress();
        if (!progress) { this.uiManager.showMessage('error', '❌ لا توجد بيانات للاستئناف'); return; }
        AppState.currentQuestionIndex = progress.currentQuestionIndex || 0;
        AppState.score = progress.score || 0;
        AppState.timeLeft = progress.timeLeft || 60;
        AppState.selectedAnswer = progress.selectedAnswer ?? null;
        this.loadCurrentQuestion();
        this.uiManager.updateScoreDisplay();
        this.timerManager.updateDisplay();
        this.uiManager.showMessage('success', '🔄 تم استئناف المسابقة من آخر نقطة توقف!');
      }
      async checkExistingProgress() {
        const progress = this.sessionManager.loadQuizProgress();
        if (progress) { this.restoreProgress(progress); this.uiManager.showMessage('info', '📁 تم استعادة تقدمك المحفوظ!'); return; }
        AppState.sessionId = `session_${AppState.studentData.studentId}_${Date.now()}`;
      }
      restoreProgress(progress) {
        AppState.currentQuestionIndex = progress.currentQuestionIndex || 0;
        AppState.score = progress.score || 0;
        AppState.timeLeft = progress.timeLeft || 60;
        AppState.selectedAnswer = progress.selectedAnswer ?? null;
      }
      loadCurrentQuestion() {
        if (AppState.currentQuestionIndex >= this.questionManager.getTotalQuestions()) { this.completeSession(); return; }
        const question = this.questionManager.getCurrentQuestion();
        if (!question) return;
        AppState.questionStartTime = Date.now();
        this.uiManager.loadQuestion(question, AppState.currentQuestionIndex, this.questionManager.getTotalQuestions());
        if (AppState.timeLeft <= 0) this.timerManager.reset();
      }
      async saveProgress() {
        const progress = {
          currentQuestionIndex: AppState.currentQuestionIndex,
          score: AppState.score,
          timeLeft: AppState.timeLeft,
          selectedAnswer: AppState.selectedAnswer,
          answers: AppState.currentQuestions.map((q, i) => ({ questionId: q.id, selected: i === AppState.currentQuestionIndex ? AppState.selectedAnswer : null, correct: q.correct })),
          lastUpdate: new Date().toISOString()
        };
        this.sessionManager.saveQuizProgress(progress);
        if (db && AppState.sessionId) {
          try {
            const ref = doc(db, 'quiz_sessions', AppState.sessionId);
            await setDoc(ref, { ...progress, lastUpdate: serverTimestamp() }, { merge: true });
            console.log('✅ Saved to Firestore');
          } catch (e) { console.warn('⚠️ Cloud save failed, kept locally'); }
        }
        this.uiManager.showMessage('success', '💾 تم حفظ تقدمك بنجاح!');
      }
      async saveAndExit() {
        if (AppState.isSubmitting) return;
        AppState.isSubmitting = true;
        this.uiManager.showLoading(true);
        await this.saveProgress();
        this.uiManager.hideSaveConfirmation();
        setTimeout(() => window.location.href = 'index.html?resume=true', 1500);
      }
      async submitAnswer() {
        if (AppState.selectedAnswer === null || AppState.isPaused) return;
        AppState.isPaused = true;
        this.timerManager.stop();
        const question = this.questionManager.getCurrentQuestion();
        const isCorrect = AppState.selectedAnswer === question.correct;
        this.uiManager.showAnswerResults(question, isCorrect);
        if (isCorrect) {
          AppState.score += question.points || 10;
          this.uiManager.updateScoreDisplay();
          this.uiManager.showMessage('success', this.getRandomSuccessMessage());
        } else {
          this.uiManager.showMessage('error', this.getRandomErrorMessage());
        }
        this.uiManager.updateControlButtons();
        await this.saveProgress();
        setTimeout(() => this.nextQuestion(), 3000);
      }
      async skipQuestion() {
        if (AppState.isPaused) return;
        AppState.isPaused = true;
        this.timerManager.stop();
        const question = this.questionManager.getCurrentQuestion();
        this.uiManager.showMessage('info', '⭐ تم تخطي السؤال! لا تقلق، يمكنك التعويض في الأسئلة القادمة!');
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          opt.style.pointerEvents = 'none';
        });
        this.uiManager.updateControlButtons();
        await this.saveProgress();
        setTimeout(() => this.nextQuestion(), 2500);
      }
      nextQuestion() {
        AppState.currentQuestionIndex++;
        document.querySelectorAll('.option').forEach(opt => {
          opt.style.pointerEvents = 'auto';
          opt.classList.remove('selected', 'correct', 'incorrect');
        });
        if (AppState.currentQuestionIndex >= this.questionManager.getTotalQuestions()) this.completeSession();
        else { this.loadCurrentQuestion(); this.timerManager.start(); }
      }
      handleTimeUp() {
        if (AppState.isPaused) return;
        AppState.isPaused = true;
        const question = this.questionManager.getCurrentQuestion();
        this.uiManager.showMessage('error', '⏰ انتهى الوقت! لا تقلق، المحاولة القادمة أفضل!');
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          opt.style.pointerEvents = 'none';
        });
        this.uiManager.updateControlButtons();
        this.saveProgress();
        setTimeout(() => this.nextQuestion(), 2500);
      }
      async completeSession() {
        AppState.sessionCompleted = true;
        this.timerManager.stop();
        const total = AppState.currentQuestions.reduce((s, q) => s + (q.points || 10), 0);
        const percentage = Math.round((AppState.score / total) * 100);
        if (db && AppState.sessionId) {
          try {
            const ref = doc(db, 'quiz_sessions', AppState.sessionId);
            await setDoc(ref, {
              completed: true,
              score: AppState.score,
              percentage,
              totalQuestions: this.questionManager.getTotalQuestions(),
              timeSpent: this.questionManager.getTotalQuestions() * 60 - AppState.timeLeft,
              lastUpdate: serverTimestamp()
            }, { merge: true });
          } catch (e) { console.warn('⚠️ Final cloud save failed'); }
        }
        this.sessionManager.clearQuizProgress();
        this.uiManager.showCompletionCard();
        setTimeout(() => window.location.href = 'leaderboard.html', 4000);
      }
      setupEventListeners() {
        document.addEventListener('click', e => {
          if (e.target.closest('.option') && !AppState.sessionCompleted && !AppState.isPaused) {
            const option = e.target.closest('.option');
            if (!option.classList.contains('correct') && !option.classList.contains('incorrect')) this.uiManager.selectAnswer(option);
          }
        });
        this.uiManager.elements.submitBtn?.addEventListener('click', () => this.submitAnswer());
        this.uiManager.elements.nextBtn?.addEventListener('click', () => this.nextQuestion());
        this.uiManager.elements.skipBtn?.addEventListener('click', () => this.skipQuestion());
        this.uiManager.elements.saveExitBtn?.addEventListener('click', () => this.uiManager.showSaveConfirmation());
        document.getElementById('confirmSaveBtn')?.addEventListener('click', () => this.saveAndExit());
        document.getElementById('cancelSaveBtn')?.addEventListener('click', () => this.uiManager.hideSaveConfirmation());
        document.addEventListener('keydown', e => {
          if (AppState.sessionCompleted || AppState.isPaused) return;
          if (e.key >= '1' && e.key <= '4') {
            const idx = parseInt(e.key) - 1;
            const opt = document.querySelector(`[data-index="${idx}"]`);
            if (opt && !opt.classList.contains('correct') && !opt.classList.contains('incorrect')) this.uiManager.selectAnswer(opt);
          } else if (e.key === 'Enter' && AppState.selectedAnswer !== null) this.submitAnswer();
          else if (e.key === 'Escape') this.skipQuestion();
          else if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); this.saveAndExit(); }
        });
        window.addEventListener('beforeunload', e => {
          if (!AppState.sessionCompleted && AppState.currentQuestionIndex > 0 && !AppState.isPaused) {
            e.preventDefault();
            e.returnValue = 'هل تريد حقاً ترك المسابقة؟ لم يتم حفظ تقدمك بعد. استخدم زر "حفظ وخروج" للحفظ الآمن.';
            return e.returnValue;
          }
        });
        window.addEventListener('beforeunload', () => { if (AppState.timerInterval) clearInterval(AppState.timerInterval); });
      }
      setupSecurity() {
        document.addEventListener('keydown', e => {
          if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) || (e.ctrlKey && ['u', 'U', 'a', 'A', 'c', 'C', 'v', 'V'].includes(e.key.toLowerCase()))) {
            e.preventDefault();
            this.uiManager.showMessage('error', '⚠️ هذه الميزة غير متاحة أثناء المسابقة!');
            return false;
          }
        });
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
      }
      getRandomSuccessMessage() {
        const msgs = ["🌟 ممتاز! إجابة صحيحة تماماً!", "🚀 رائع! أنت تتقدم بثبات!", "🏆 أحسنت! واصل هذا التميز!", "⭐ عبقري! إجابة مثالية!", "🎯 دقيق جداً! أنت محترف!"];
        return msgs[Math.floor(Math.random() * msgs.length)];
      }
      getRandomErrorMessage() {
        const msgs = ["💪 لا تيأس! التعلم من الأخطاء قوة!", "🌱 كل خطأ خطوة نحو التفوق!", "🔄 لا بأس! المحاولة القادمة ستكون أفضل!", "🌟 الأخطاء طريق النجاح! تقدم للأمام!"];
        return msgs[Math.floor(Math.random() * msgs.length)];
      }
      showFallback() {
        this.uiManager.showMessage('error', '⚠️ لم نتمكن من تحميل الأسئلة، تأكد من اتصالك ثم أعد التحميل.');
      }
    }

    // ============== Initialize App ==============
    const quizController = new QuizController();
    await quizController.start();

    // ============== Global Error Handlers ==============
    window.addEventListener('error', e => console.error('💥 Global error:', e.error));
    window.addEventListener('unhandledrejection', e => console.error('💥 Unhandled rejection:', e.reason));
  </script>
</body>
</html>
