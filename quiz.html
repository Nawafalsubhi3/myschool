<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex,nofollow">
  <title>مسابقة نافس - متوسطة المنذر بن عمرو الأنصاري</title>

  <!-- ========  Critical CSS (inlined)  ======== -->
  <style>
    :root{--primary:#6366f1;--success:#10b981;--danger:#ef4444;--radius:15px;--shadow:0 15px 35px rgba(99,102,241,.4)}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);user-select:none;color:#fff}
    .hidden{display:none!important}
    .container{background:rgba(255,255,255,.98);padding:40px;border-radius:25px;box-shadow:var(--shadow);max-width:650px;width:100%;backdrop-filter:blur(20px)}
    .ministry-header{background:linear-gradient(135deg,#1e3a8a,#3730a3);color:#fff;padding:20px;border-radius:var(--radius);margin-bottom:25px;font-weight:600;line-height:1.4}
    .logo{font-size:4em;margin:25px 0;background:linear-gradient(135deg,var(--primary),#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .title{font-size:2.5em;font-weight:900;background:linear-gradient(135deg,#1e293b,#475569);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
    .subtitle{color:#64748b;margin-bottom:35px;font-size:1.1em;font-weight:500}
    .form-group{margin-bottom:25px;text-align:right}
    .form-label{display:block;margin-bottom:10px;font-weight:700;color:#374151;font-size:1.05em}
    .form-control{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:1em;transition:all .3s ease;background:#fafafa;font-weight:500}
    .form-control:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
    .form-control.error{border-color:var(--danger);background:#fef2f2;animation:shake .5s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .btn{background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;border:none;padding:18px 35px;border-radius:15px;font-size:1.1em;font-weight:700;cursor:pointer;width:100%;margin-top:25px;transition:all .3s ease;box-shadow:0 8px 25px rgba(99,102,241,.3)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(99,102,241,.4)}
    .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none;box-shadow:none}
    .status{margin-top:25px;padding:18px;border-radius:12px;display:none;font-weight:600;font-size:1em}
    .status.error{background:linear-gradient(135deg,#fee2e2,#fecaca);color:#991b1b;border:1px solid var(--danger)}
    .status.loading{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af;border:1px solid #3b82f6}
    .validation-message{color:var(--danger);font-size:.9em;margin-top:8px;text-align:center;font-weight:600}
    .validation-message.success{color:var(--success)}
    .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite;margin-right:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .developer-info{margin-top:35px;padding:20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:15px;border-right:4px solid var(--primary);text-align:center}
    .developer-name{color:var(--primary);font-weight:700;margin-bottom:8px;font-size:1.05em}
    .school-year{color:#64748b;font-size:.85em;font-weight:500}
    @media(max-width:768px){.container{padding:25px 20px;margin:10px}.title{font-size:2em}.logo{font-size:3em}}
  </style>
</head>
<body>
  <div class="container">
    <div class="ministry-header">
      <div>🇸🇦 المملكة العربية السعودية - وزارة التعليم</div>
      <div>متوسطة المنذر بن عمرو الأنصاري</div>
      <div style="font-size:.85em;opacity:.9;border-top:1px solid rgba(255,255,255,.2);padding-top:8px;margin-top:8px">مدير المدرسة: خالد المطيري</div>
    </div>

    <div class="logo">🏆</div>
    <h1 class="title">نافس</h1>
    <p class="subtitle">منصة المسابقات التعليمية الذكية<br>تعلم، تنافس، وتفوق مع أقرانك</p>

    <form id="regForm">
      <!-- الاسم الرباعي -->
      <div class="form-group">
        <label>📝 الاسم الرباعي (إجباري):</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <input type="text" id="firstName" class="form-control" placeholder="الاسم الأول" required maxlength="20">
          <input type="text" id="fatherName" class="form-control" placeholder="اسم الأب" required maxlength="20">
          <input type="text" id="grandFatherName" class="form-control" placeholder="اسم الجد" required maxlength="20">
          <input type="text" id="familyName" class="form-control" placeholder="اسم العائلة" required maxlength="20">
        </div>
        <div id="nameValidation" class="validation-message"></div>
      </div>

      <!-- الصف والشعبة -->
      <div class="form-group">
        <label for="grade">🎓 الصف الدراسي:</label>
        <select id="grade" class="form-control" required>
          <option value="">اختر الصف الدراسي</option>
          <option value="الأول متوسط">الأول متوسط</option>
          <option value="الثاني متوسط">الثاني متوسط</option>
          <option value="الثالث متوسط">الثالث متوسط</option>
        </select>
      </div>

      <div class="form-group">
        <label for="section">🏫 الشعبة:</label>
        <select id="section" class="form-control" required>
          <option value="">اختر الشعبة</option>
          <option value="1">الشعبة الأولى</option>
          <option value="2">الشعبة الثانية</option>
          <option value="3">الشعبة الثالثة</option>
          <option value="4">الشعبة الرابعة</option>
          <option value="5">الشعبة الخامسة</option>
          <option value="6">الشعبة السادسة</option>
        </select>
      </div>

      <!-- اختيار الرمز -->
      <div class="form-group">
        <label>🎨 اختر رمزك المميز (إجباري):</label>
        <div class="icon-selector" id="iconSelector" style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;max-height:400px;overflow-y:auto;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa"></div>
        <div id="iconValidation" class="validation-message"></div>
      </div>

      <button type="submit" class="btn" id="submitBtn">🚀 دخول المسابقة</button>
    </form>

    <div id="status" class="status"></div>

    <p style="margin-top:25px;color:#64748b">لديك حساب بالفعل؟ <a href="login.html" class="link">سجّل دخولك الآن</a></p>

    <div class="developer-info">
      <div class="developer-name">تنفيذ وإشراف: الأستاذ نواف الصبحي</div>
      <div class="school-year">متوسطة المنذر بن عمرو الأنصاري - 2025</div>
    </div>
  </div>

  <!-- نافذة الرقم السري -->
  <div id="pinModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>🎉 تم التسجيل بنجاح!</h3>
        <span class="pin-close">&times;</span>
      </div>
      <div class="modal-body">
        <p>رقمك السري هو:</p>
        <div class="pin-display" id="pinDisplay"></div>
        <p class="pin-note">احتفظ بهذا الرقم لتسجيل الدخول لاحقاً</p>
      </div>
      <div class="modal-footer">
        <button id="pinOk" class="btn-primary">موافق</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ========== Firebase ==========
    const firebaseConfig = {
      apiKey: "AIzaSyA5yepZwrOlqFiV_KkVHp9dBaaT65pgdRo",
      authDomain: "nafs-competition.firebaseapp.com",
      projectId: "nafs-competition",
      storageBucket: "nafs-competition.firebasestorage.app",
      messagingSenderId: "182205828634",
      appId: "1:182205828634:web:dee889f770eb52ff668ba3"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let selectedIcon = '';
    let isSubmitting = false;

    // ========== Utilities ==========
    const showStatus = (msg, type) => {
      const s = document.getElementById('status');
      s.textContent = msg; s.className = `status ${type}`; s.style.display = 'block';
      if (type === 'success' || type === 'error') setTimeout(() => s.style.display = 'none', 5000);
    };
    const showValidation = (id, msg, ok) => {
      const el = document.getElementById(id);
      el.textContent = msg; el.className = 'validation-message' + (ok ? ' success' : '');
    };

    // ========== Icons ==========
    const icons = ['🌟','🚀','⚡','🔥','💎','🎯','🏆','👑','🦁','🦅','🐺','🦖','🌙','☀️','⭐','🌈'];
    const iconContainer = document.getElementById('iconSelector');
    icons.forEach((ic, i) => {
      const div = document.createElement('div');
      div.className = 'icon-option'; div.dataset.icon = ic; div.textContent = ic;
      div.style.setProperty('--i', i);
      iconContainer.appendChild(div);
    });
    iconContainer.addEventListener('click', e => {
      if (e.target.classList.contains('icon-option')) {
        iconContainer.querySelectorAll('.icon-option').forEach(x => x.classList.remove('selected'));
        e.target.classList.add('selected');
        selectedIcon = e.target.dataset.icon;
        showValidation('iconValidation', '', true);
      }
    });

    // ========== Validation ==========
    const validateName = () => {
      const parts = ['firstName', 'fatherName', 'grandFatherName', 'familyName'].map(id => document.getElementById(id).value.trim());
      if (parts.some(p => p.length < 2)) return showValidation('nameValidation', 'يجب إدخال الاسم الرباعي كاملاً (كل جزء حرفين على الأقل)', false), false;
      if (parts.some(p => !/^[\u0600-\u06FF\s]+$/.test(p))) return showValidation('nameValidation', 'استخدم الأحرف العربية فقط', false), false;
      showValidation('nameValidation', '✅ الاسم صحيح', true);
      return true;
    };
    document.querySelectorAll('#firstName, #fatherName, #grandFatherName, #familyName').forEach(inp => {
      inp.addEventListener('input', e => {
        e.target.value = e.target.value.replace(/[^\u0600-\u06FF\s]/g, '');
        validateName();
      });
    });

    // ========== Submit ==========
    document.getElementById('regForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!validateName() || !document.getElementById('grade').value || !document.getElementById('section').value || !selectedIcon) {
        showStatus('⚠️ يرجى إكمال جميع الحقول', 'error'); return;
      }
      if (isSubmitting) return;
      isSubmitting = true;
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.innerHTML = '⏳ جاري التحقق...';

      try {
        await signInAnonymously(auth);
        const parts = ['firstName', 'fatherName', 'grandFatherName', 'familyName'].map(id => document.getElementById(id).value.trim());
        const fullName = parts.join(' ');
        const grade = document.getElementById('grade').value;
        const section = document.getElementById('section').value;
        const pin = Math.floor(1000 + Math.random() * 9000);
        const studentId = `STD_${grade.replace(/\D/g, '')}_${section}_${Date.now().toString(36)}`;

        await setDoc(doc(db, 'students', studentId), {
          studentId, firstName: parts[0], fatherName: parts[1], grandFatherName: parts[2], familyName: parts[3], fullName, grade, section, icon: selectedIcon, pin,
          registrationTime: serverTimestamp(), isActive: true, totalCompetitions: 0, totalScore: 0, averageScore: 0, lastActivity: serverTimestamp()
        });

        // حفظ محلي + جلسة
        const payload = { studentId, fullName, grade, section, icon: selectedIcon, timestamp: Date.now() };
        localStorage.setItem('nafes_student_data', JSON.stringify(payload));
        sessionStorage.setItem('nafes_student_data', JSON.stringify(payload));

        // عرض الرقم السري ثم الانتقال الفوري
        document.getElementById('pinDisplay').textContent = pin;
        document.getElementById('pinModal').classList.remove('hidden');

      } catch (err) {
        console.error(err); showStatus('❌ حدث خطأ أثناء الحفظ', 'error');
        btn.disabled = false; btn.innerHTML = '🚀 دخول المسابقة'; isSubmitting = false;
      }
    });

    // ========== Pin Modal ==========
    document.querySelector('.pin-close').onclick = () => document.getElementById('pinModal').classList.add('hidden');
    document.getElementById('pinOk').onclick = () => {
      document.getElementById('pinModal').classList.add('hidden');
      showStatus('✅ تم التسجيل بنجاح! جاري التوجيه...', 'success');
      setTimeout(() => window.location.replace('quiz.html'), 1200);
    };

    // ========== Security ==========
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase())) || (e.ctrlKey && ['u','U'].includes(e.key.toLowerCase()))) e.preventDefault();
    });
  </script>
</body>
</html>
