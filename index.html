<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقة نافس - متوسطة المنذر بن عمرو الأنصاري</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;display:flex;align-items:center;justify-content:center;
            padding:20px;user-select:none
        }
        .container{
            background:rgba(255,255,255,.98);padding:40px;border-radius:25px;
            box-shadow:0 25px 50px rgba(0,0,0,.2);max-width:650px;width:100%;
            backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.3)
        }
        .login-link-container{
            background:linear-gradient(135deg,#f3f4f6,#e5e7eb);
            padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;
            border:1px solid #d1d5db
        }
        .login-link{
            color:#6366f1;text-decoration:none;font-weight:700;font-size:1.1em;
            display:inline-flex;align-items:center;gap:8px;transition:.3s
        }
        .login-link:hover{color:#8b5cf6;transform:translateX(-3px)}
        .existing-session{
            background:linear-gradient(135deg,#10b981,#059669);color:#fff;
            padding:25px;border-radius:20px;margin-bottom:25px;text-align:center;
            box-shadow:0 10px 25px rgba(16,185,129,.3)
        }
        .session-actions{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
        .session-btn{
            background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.3);
            padding:12px 25px;border-radius:15px;font-weight:600;cursor:pointer;
            transition:.3s;text-decoration:none;display:inline-block
        }
        .session-btn:hover{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.5)}
        .session-btn.primary{background:rgba(255,255,255,.9);color:#059669;border-color:rgba(255,255,255,.9)}
        .ministry-header{
            background:linear-gradient(135deg,#1e3a8a,#3730a3);color:#fff;padding:20px;
            border-radius:15px;margin-bottom:25px;font-weight:600;line-height:1.4
        }
        .logo{font-size:4.5em;margin:25px 0;background:linear-gradient(135deg,#6366f1,#8b5cf6);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.1))}
        .title{font-size:3em;font-weight:900;background:linear-gradient(135deg,#1e293b,#475569);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
        .subtitle{color:#64748b;margin-bottom:35px;font-size:1.2em;line-height:1.5}
        .name-inputs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .form-control{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;
            font-size:1em;background:#fafafa;transition:.3s;font-weight:500}
        .form-control:focus{outline:none;border-color:#6366f1;background:#fff;
            box-shadow:0 0 0 3px rgba(99,102,241,.1);transform:translateY(-1px)}
        .form-control.error{border-color:#ef4444;background:#fef2f2;animation:shake .5s ease}
        .form-control.success{border-color:#10b981;background:#f0fdf4}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .icon-selector{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:15px;
            max-height:400px;overflow-y:auto;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa}
        .icon-option{background:#f8fafc;border:2px solid #e2e8f0;border-radius:15px;padding:18px;
            font-size:2em;cursor:pointer;transition:.3s;text-align:center;opacity:0}
        .icon-option:hover{background:#f1f5f9;transform:scale(1.1);box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .icon-option.selected{background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:#6366f1;
            color:#fff;transform:scale(1.15);box-shadow:0 12px 30px rgba(99,102,241,.4)}
        .btn{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;
            padding:18px 35px;border-radius:15px;font-size:1.1em;font-weight:700;cursor:pointer;
            width:100%;margin-top:25px;transition:.3s;box-shadow:0 8px 25px rgba(99,102,241,.3)}
        .btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(99,102,241,.4)}
        .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none;box-shadow:none}
        .status{margin-top:25px;padding:18px;border-radius:12px;display:none;font-weight:600;font-size:1em}
        .status.success{background:linear-gradient(135deg,#d1fae5,#a7f3d0);color:#065f46;border:1px solid #10b981}
        .status.error{background:linear-gradient(135deg,#fee2e2,#fecaca);color:#991b1b;border:1px solid #ef4444}
        .validation-message{color:#ef4444;font-size:.9em;margin-top:8px;text-align:center;font-weight:600}
        .validation-message.success{color:#10b981}
        .developer-info{margin-top:35px;padding:20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);
            border-radius:15px;border-right:4px solid #6366f1;text-align:center}
        .developer-name{color:#6366f1;font-weight:700;margin-bottom:8px;font-size:1.05em}
        .school-year{color:#64748b;font-size:.85em;font-weight:500}
        @media(max-width:768px){.name-inputs{grid-template-columns:1fr}.icon-selector{grid-template-columns:repeat(4,1fr)}}
    </style>
</head>
<body>
    <div class="container">
        <div class="login-link-container">
            <p style="margin:0;color:#374151">لديك حساب بالفعل؟ <a href="login.html" class="login-link">سجّل دخولك الآن</a></p>
        </div>

        <div class="existing-session hidden" id="existingSession">
            <div style="font-size:3em;margin-bottom:15px">👋</div>
            <div style="font-size:1.5em;font-weight:700;margin-bottom:10px">مرحباً بعودتك!</div>
            <div id="sessionDetails"></div>
            <div class="session-actions">
                <a href="#" class="session-btn primary" id="continueBtn">🚀 متابعة المسابقة</a>
                <button class="session-btn" id="newSessionBtn">🔄 بدء جلسة جديدة</button>
                <a href="leaderboard.html" class="session-btn">🏆 لوحة الشرف</a>
            </div>
        </div>

        <div id="registrationForm">
            <div class="ministry-header">
                <div>🇸🇦 المملكة العربية السعودية - وزارة التعليم</div>
                <div>متوسطة المنذر بن عمرو الأنصاري</div>
                <div style="font-size:.85em;opacity:.9;border-top:1px solid rgba(255,255,255,.2);padding-top:8px;margin-top:8px">مدير المدرسة: خالد المطيري</div>
            </div>

            <div class="logo">🏆</div>
            <h1 class="title">نافس</h1>
            <p class="subtitle">منصة المسابقات التعليمية الذكية<br>تعلم، تنافس، وتفوق مع أقرانك</p>

            <form id="loginForm">
                <div class="form-group">
                    <label>📝 الاسم الرباعي (إجباري):</label>
                    <div class="name-inputs">
                        <input type="text" id="firstName" class="form-control" placeholder="الاسم الأول" required maxlength="20">
                        <input type="text" id="fatherName" class="form-control" placeholder="اسم الأب" required maxlength="20">
                        <input type="text" id="grandFatherName" class="form-control" placeholder="اسم الجد" required maxlength="20">
                        <input type="text" id="familyName" class="form-control" placeholder="اسم العائلة" required maxlength="20">
                    </div>
                    <div class="help-text">يجب إدخال الاسم الرباعي كاملاً بدون أخطاء إملائية</div>
                    <div id="nameValidation" class="validation-message"></div>
                </div>

                <div class="form-group">
                    <label for="grade">🎓 الصف الدراسي:</label>
                    <select id="grade" class="form-control" required>
                        <option value="">اختر الصف الدراسي</option>
                        <option value="الأول متوسط">الأول متوسط</option>
                        <option value="الثاني متوسط">الثاني متوسط</option>
                        <option value="الثالث متوسط">الثالث متوسط</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="section">🏫 الشعبة:</label>
                    <select id="section" class="form-control" required>
                        <option value="">اختر الشعبة</option>
                        <option value="1">الشعبة الأولى</option>
                        <option value="2">الشعبة الثانية</option>
                        <option value="3">الشعبة الثالثة</option>
                        <option value="4">الشعبة الرابعة</option>
                        <option value="5">الشعبة الخامسة</option>
                        <option value="6">الشعبة السادسة</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>🎨 اختر رمزك المميز (إجباري):</label>
                    <div class="icon-selector" id="iconSelector">
                        <div class="icon-option" data-icon="🌟">🌟</div><div class="icon-option" data-icon="🚀">🚀</div><div class="icon-option" data-icon="⚡">⚡</div><div class="icon-option" data-icon="🔥">🔥</div><div class="icon-option" data-icon="💎">💎</div><div class="icon-option" data-icon="🎯">🎯</div><div class="icon-option" data-icon="🏆">🏆</div><div class="icon-option" data-icon="👑">👑</div><div class="icon-option" data-icon="🦁">🦁</div><div class="icon-option" data-icon="🦅">🦅</div><div class="icon-option" data-icon="🐺">🐺</div><div class="icon-option" data-icon="🦖">🦖</div><div class="icon-option" data-icon="🌙">🌙</div><div class="icon-option" data-icon="☀️">☀️</div><div class="icon-option" data-icon="⭐">⭐</div><div class="icon-option" data-icon="🌈">🌈</div>
                    </div>
                    <div class="help-text">اختر رمزاً يمثلك في المسابقة (لا يمكن تكراره في نفس الصف والشعبة)</div>
                    <div id="iconValidation" class="validation-message"></div>
                </div>

                <button type="submit" class="btn" id="submitBtn">🚀 دخول المسابقة</button>
            </form>

            <div id="status" class="status"></div>

            <div class="developer-info">
                <div class="developer-name">تنفيذ وإشراف: الأستاذ نواف الصبحي</div>
                <div class="school-year">متوسطة المنذر بن عمرو الأنصاري - 2025</div>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey:"AIzaSyA5yepZwrOlqFiV_KkVHp9dBaaT65pgdRo",
            authDomain:"nafs-competition.firebaseapp.com",
            projectId:"nafs-competition",
            storageBucket:"nafs-competition.firebasestorage.app",
            messagingSenderId:"182205828634",
            appId:"1:182205828634:web:dee889f770eb52ff668ba3"
        };
        import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import{getAuth,signInAnonymously}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import{getFirestore,collection,addDoc,serverTimestamp,query,where,getDocs,doc,setDoc}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
        let selectedIcon='',currentUser=null,isSubmitting=false;

        document.addEventListener('DOMContentLoaded',async()=>{
            await initializeAuth();
            checkExistingSession();
            setupEventListeners();
        });

        async function initializeAuth(){
            try{
                const uc=await signInAnonymously(auth);
                currentUser=uc.user;
            }catch(e){
                showStatus('⚠️ مشكلة في الاتصال بالخادم','error');
            }
        }

        function checkExistingSession(){
            const saved=localStorage.getItem('nafes_student_data');
            if(!saved)return;
            try{
                const data=JSON.parse(saved);
                if(data.studentId&&data.fullName&&(Date.now()-data.timestamp)<7*24*60*60*1000){
                    showExistingSession(data);
                    return true;
                }else{
                    localStorage.removeItem('nafes_student_data');
                }
            }catch(e){
                localStorage.removeItem('nafes_student_data');
            }
            return false;
        }

        function showExistingSession(data){
            document.getElementById('existingSession').classList.remove('hidden');
            document.getElementById('registrationForm').classList.add('hidden');
            document.getElementById('sessionDetails').innerHTML=`
                ${data.icon} <strong>${data.fullName}</strong><br>
                ${data.grade} - الشعبة ${data.section}<br>
                <small>آخر نشاط: ${formatRelativeTime(data.timestamp)}</small>
            `;
            document.getElementById('continueBtn').onclick=e=>{
                e.preventDefault();continueToQuiz();
            };
            document.getElementById('newSessionBtn').onclick=()=>startNewSession();
        }

        async function continueToQuiz(){
            const saved=localStorage.getItem('nafes_student_data');
            if(!saved){window.location.href='index.html';return;}
            const data=JSON.parse(saved);
            const prog=JSON.parse(sessionStorage.getItem('nafes_quiz_progress')||'null');
            if(prog&&prog.studentId===data.studentId){
                window.location.href='quiz.html?resume=1';
            }else{
                window.location.href='thank-you.html';
            }
        }

        function startNewSession(){
            if(confirm('هل أنت متأكد من بدء جلسة جديدة؟ سيتم حذف البيانات السابقة.')){
                localStorage.removeItem('nafes_student_data');
                sessionStorage.removeItem('nafes_quiz_progress');
                location.reload();
            }
        }

        function formatRelativeTime(ts){
            const diff=Date.now()-ts,m=Math.floor(diff/60000),h=Math.floor(diff/3600000),d=Math.floor(diff/86400000);
            if(m<60)return`منذ ${m} دقيقة`;if(h<24)return`منذ ${h} ساعة`;return`منذ ${d} يوم`;
        }

        function setupEventListeners(){
            document.querySelectorAll('.icon-option').forEach(opt=>{
                opt.addEventListener('click',function(){
                    document.querySelectorAll('.icon-option').forEach(i=>i.classList.remove('selected'));
                    this.classList.add('selected');selectedIcon=this.dataset.icon;
                    document.getElementById('iconValidation').textContent='';
                });
            });
            ['firstName','fatherName','grandFatherName','familyName'].forEach(id=>{
                document.getElementById(id).addEventListener('input',validateNameInput);
                document.getElementById(id).addEventListener('blur',validateName);
            });
            document.getElementById('loginForm').addEventListener('submit',handleSubmit);
        }

        function validateNameInput(e){
            const val=e.target.value,ar=/^[\u0600-\u06FF\s]*$/;
            if(val&&!ar.test(val)){e.target.value=val.replace(/[^\u0600-\u06FF\s]/g,'');}
        }

        function validateName(){
            const fn=document.getElementById('firstName').value.trim(),
                  fa=document.getElementById('fatherName').value.trim(),
                  g=document.getElementById('grandFatherName').value.trim(),
                  fam=document.getElementById('familyName').value.trim();
            if(!fn||!fa||!g||!fam){showValidationMessage('nameValidation','يجب إدخال الاسم الرباعي كاملاً',false);return false;}
            const parts=[fn,fa,g,fam];
            for(let p of parts)if(p.length<2||!/^[\u0600-\u06FF\s]+$/.test(p)){showValidationMessage('nameValidation','يجب استخدام الأحرف العربية فقط وكل جزء حرفين على الأقل',false);return false;}
            parts.forEach((_,i)=>document.getElementById(['firstName','fatherName','grandFatherName','familyName'][i]).classList.add('success'));
            showValidationMessage('nameValidation','✅ الاسم صحيح',true);return true;
        }

        function showValidationMessage(id,msg,ok){
            const el=document.getElementById(id);el.textContent=msg;el.className='validation-message'+(ok?' success':'');
        }

        async function handleSubmit(e){
            e.preventDefault();
            if(!currentUser){showStatus('⚠️ يرجى الانتظار حتى اكتمال الاتصال','error');return;}
            if(isSubmitting)return;
            if(!validateName()||!selectedIcon){showStatus('⚠️ يرجى تصحيح البيانات','error');return;}
            isSubmitting=true;const submitBtn=document.getElementById('submitBtn');
            submitBtn.disabled=true;submitBtn.innerHTML='⏳ جاري التحقق...';
            try{
                const fn=document.getElementById('firstName').value.trim(),
                      fa=document.getElementById('fatherName').value.trim(),
                      g=document.getElementById('grandFatherName').value.trim(),
                      fam=document.getElementById('familyName').value.trim(),
                      fullName=`${fn} ${fa} ${g} ${fam}`,
                      grade=document.getElementById('grade').value,
                      section=document.getElementById('section').value;
                if(!grade||!section){showStatus('⚠️ يرجى اختيار الصف والشعبة','error');isSubmitting=false;submitBtn.disabled=false;submitBtn.innerHTML='🚀 دخول المسابقة';return;}
                const studentId=`STD_${grade.replace(/[^0-9]/g,'')}_${section}_${Date.now().toString(36)}`;
                const pin=Math.floor(1000+Math.random()*9000);
                await setDoc(doc(db,'students',studentId),{
                    studentId,firstName:fn,fatherName:fa,grandFatherName:g,familyName:fam,fullName,grade,section,icon:selectedIcon,pin,
                    registrationTime:serverTimestamp(),isActive:true,totalCompetitions:0,totalScore:0,averageScore:0,lastActivity:serverTimestamp()
                });
                const studentData={studentId,fullName,grade,section,icon:selectedIcon,pin,timestamp:Date.now()};
                localStorage.setItem('nafes_student_data',JSON.stringify(studentData));
                document.getElementById('pinDisplay').textContent=pin;
                document.getElementById('pinModal').style.display='flex';
            }catch(err){
                showStatus(`❌ ${err.message}`,'error');
                isSubmitting=false;submitBtn.disabled=false;submitBtn.innerHTML='🚀 دخول المسابقة';
            }
        }

        function showStatus(msg,type){
            const s=document.getElementById('status');s.textContent=msg;s.className=`status ${type}`;s.style.display='block';
            if(type==='success'||type==='error')setTimeout(()=>s.style.display='none',5000);
        }

        // مودال عرض الرقم السري
        const modal=document.getElementById('pinModal');
        document.querySelector('.pin-close').onclick=()=>modal.style.display='none';
        document.getElementById('pinOk').onclick=()=>{
            modal.style.display='none';
            showStatus('✅ تم تسجيل دخولك بنجاح! جاري التوجيه...','success');
            setTimeout(()=>window.location.href='thank-you.html',1500);
        };
    </script>
</body>
</html>
