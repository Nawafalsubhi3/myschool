<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقة نافس - متوسطة المنذر بن عمرو الأنصاري</title>
    <meta name="description" content="منصة المسابقات التعليمية الذكية - متوسطة المنذر بن عمرو الأنصاري">
    <meta name="robots" content="noindex, nofollow">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;direction:rtl;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .container{background:rgba(255,255,255,.98);padding:40px;border-radius:25px;box-shadow:0 25px 50px rgba(0,0,0,.2);text-align:center;max-width:650px;width:100%;backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.3);position:relative;overflow:hidden}
        .login-link-container{background:linear-gradient(135deg,#f3f4f6,#e5e7eb);padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;border:1px solid #d1d5db}
        .login-link{color:#6366f1;text-decoration:none;font-weight:700;font-size:1.1em;display:inline-flex;align-items:center;gap:8px;transition:all .3s ease}
        .login-link:hover{color:#8b5cf6;transform:translateX(-3px)}
        .login-link::before{content:'🔑'}
        .pin-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
        .pin-modal-content{background:#fff;padding:30px 40px;border-radius:20px;text-align:center;max-width:350px;width:90%;box-shadow:0 15px 40px rgba(0,0,0,.2)}
        .pin-number{font-size:2.5em;font-weight:900;color:#6366f1;margin:15px 0;letter-spacing:4px}
        .pin-close{float:left;font-size:28px;font-weight:bold;color:#999;cursor:pointer}
        .pin-close:hover{color:#6366f1}
        .existing-session{background:linear-gradient(135deg,#10b981,#059669);color:white;padding:25px;border-radius:20px;margin-bottom:25px;text-align:center;box-shadow:0 10px 25px rgba(16,185,129,.3)}
        .session-icon{font-size:3em;margin-bottom:15px}
        .session-title{font-size:1.5em;font-weight:700;margin-bottom:10px}
        .session-details{font-size:1em;margin-bottom:20px;opacity:.9}
        .session-actions{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
        .session-btn{background:rgba(255,255,255,.2);color:white;border:2px solid rgba(255,255,255,.3);padding:12px 25px;border-radius:15px;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-block}
        .session-btn:hover{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.5);transform:translateY(-2px)}
        .session-btn.primary{background:rgba(255,255,255,.9);color:#059669;border-color:rgba(255,255,255,.9)}
        .session-btn.primary:hover{background:white;color:#047857}
        .ministry-header{background:linear-gradient(135deg,#1e3a8a,#3730a3);color:white;padding:20px;border-radius:15px;margin-bottom:25px;font-weight:600;line-height:1.4;box-shadow:0 8px 25px rgba(30,58,138,.3)}
        .school-info{font-size:.95em;margin-bottom:8px}
        .principal-info{font-size:.85em;opacity:.9;border-top:1px solid rgba(255,255,255,.2);padding-top:8px;margin-top:8px}
        .logo{font-size:4.5em;margin:25px 0;background:linear-gradient(135deg,#6366f1,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.1))}
        .title{font-size:3em;color:#1e293b;margin-bottom:10px;font-weight:900;background:linear-gradient(135deg,#1e293b,#475569);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{color:#64748b;margin-bottom:35px;font-size:1.2em;font-weight:500;line-height:1.5}
        .form-group{margin-bottom:25px;text-align:right}
        .form-group label{display:block;margin-bottom:10px;font-weight:700;color:#374151;font-size:1.05em}
        .name-inputs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .form-control{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:1em;transition:all .3s ease;background:#fafafa;font-weight:500}
        .form-control:focus{outline:none;border-color:#6366f1;background:white;box-shadow:0 0 0 3px rgba(99,102,241,.1);transform:translateY(-1px)}
        .form-control.error{border-color:#ef4444;background:#fef2f2;animation:shake .5s ease-in-out}
        .form-control.success{border-color:#10b981;background:#f0fdf4}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .icon-selector{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:15px;max-height:400px;overflow-y:auto;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa}
        .icon-option{background:#f8fafc;border:2px solid #e2e8f0;border-radius:15px;padding:18px;font-size:2em;cursor:pointer;transition:all .3s ease;text-align:center;position:relative;overflow:hidden;opacity:0;animation:fadeInIcon .5s ease forwards}
        @keyframes fadeInIcon{to{opacity:1}}
        .icon-option:hover{background:#f1f5f9;transform:scale(1.1);box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .icon-option.selected{background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:#6366f1;color:white;transform:scale(1.15);box-shadow:0 12px 30px rgba(99,102,241,.4)}
        .btn{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;padding:18px 35px;border-radius:15px;font-size:1.1em;font-weight:700;cursor:pointer;width:100%;margin-top:25px;transition:all .3s ease;box-shadow:0 8px 25px rgba(99,102,241,.3);position:relative;overflow:hidden}
        .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
        .btn:hover::before{left:100%}
        .btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(99,102,241,.4)}
        .btn:disabled{background:#9ca3af;cursor:not-allowed;transform:none;box-shadow:none}
        .btn:disabled::before{display:none}
        .status{margin-top:25px;padding:18px;border-radius:12px;display:none;font-weight:600;font-size:1em;animation:slideIn .3s ease}
        @keyframes slideIn{from{transform:translateY(-10px);opacity:0}to{transform:translateY(0);opacity:1}}
        .status.success{background:linear-gradient(135deg,#d1fae5,#a7f3d0);color:#065f46;border:1px solid #10b981}
        .status.error{background:linear-gradient(135deg,#fee2e2,#fecaca);color:#991b1b;border:1px solid #ef4444}
        .status.loading{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af;border:1px solid #3b82f6}
        .validation-message{color:#ef4444;font-size:.9em;margin-top:8px;text-align:center;font-weight:600;transition:all .3s ease}
        .validation-message.success{color:#10b981}
        .help-text{font-size:.9em;color:#6b7280;margin-top:8px;text-align:center;font-weight:500}
        .developer-info{margin-top:35px;padding:20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:15px;border-right:4px solid #6366f1;text-align:center}
        .developer-name{color:#6366f1;font-weight:700;margin-bottom:8px;font-size:1.05em}
        .school-year{color:#64748b;font-size:.85em;font-weight:500}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #ffffff;border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite;margin-left:10px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .security-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);color:white;display:none;justify-content:center;align-items:center;z-index:9999;font-size:1.5em;text-align:center}
        .hidden{display:none!important}
        @media(max-width:768px){.container{padding:25px 20px;margin:10px}.name-inputs{grid-template-columns:1fr}.icon-selector{grid-template-columns:repeat(4,1fr)}.title{font-size:2.2em}.logo{font-size:3.5em}.session-actions{flex-direction:column}.login-link-container{padding:12px}}
    </style>
</head>
<body>
    <div class="security-overlay" id="securityOverlay"><div>تم اكتشاف محاولة غير مصرحة<br>يرجى إغلاق أدوات المطور والمتابعة بشكل طبيعي</div></div>
    <div id="pinModal" class="pin-modal"><div class="pin-modal-content"><span class="pin-close">&times;</span><h2>🎉 تم إنشاء حسابك!</h2><p>احفظ هذا الرقم السري جيداً:</p><div id="pinDisplay" class="pin-number"></div><p style="margin-top:15px;font-size:.9em;color:#6b7280;">ستستخدمه لتسجيل الدخول لاحقاً</p><button id="pinOk" class="btn" style="margin-top:20px;width:auto;">حسناً</button></div></div>
    <div class="container">
        <div class="login-link-container"><p style="margin:0;color:#374151">لديك حساب بالفعل؟ <a href="login.html" class="login-link">سجّل دخولك الآن</a></p></div>
        <div class="existing-session hidden" id="existingSession"><div class="session-icon">👋</div><div class="session-title">مرحباً بعودتك!</div><div class="session-details" id="sessionDetails">لديك جلسة مسجلة مسبقاً</div><div class="session-actions"><a href="#" class="session-btn primary" id="continueBtn">🚀 متابعة المسابقة</a><button class="session-btn" id="newSessionBtn">🔄 بدء جلسة جديدة</button><a href="leaderboard.html" class="session-btn">🏆 لوحة الشرف</a></div></div>
        <div id="registrationForm"><div class="ministry-header"><div class="school-info">🇸🇦 المملكة العربية السعودية - وزارة التعليم</div><div class="school-info">متوسطة المنذر بن عمرو الأنصاري</div><div class="principal-info">مدير المدرسة: خالد المطيري</div></div><div class="logo">🏆</div><h1 class="title">نافس</h1><p class="subtitle">منصة المسابقات التعليمية الذكية<br>تعلم، تنافس، وتفوق مع أقرانك</p><form id="loginForm"><div class="form-group"><label>📝 الاسم الرباعي (إجباري):</label><div class="name-inputs"><input type="text" id="firstName" class="form-control" placeholder="الاسم الأول" required autocomplete="off" maxlength="20"><input type="text" id="fatherName" class="form-control" placeholder="اسم الأب" required autocomplete="off" maxlength="20"><input type="text" id="grandFatherName" class="form-control" placeholder="اسم الجد" required autocomplete="off" maxlength="20"><input type="text" id="familyName" class="form-control" placeholder="اسم العائلة" required autocomplete="off" maxlength="20"></div><div class="help-text">يجب إدخال الاسم الرباعي كاملاً بدون أخطاء إملائية</div><div id="nameValidation" class="validation-message"></div></div><div class="form-group"><label for="grade">🎓 الصف الدراسي:</label><select id="grade" class="form-control" required><option value="">اختر الصف الدراسي</option><option value="الأول متوسط">الأول متوسط</option><option value="الثاني متوسط">الثاني متوسط</option><option value="الثالث متوسط">الثالث متوسط</option></select></div><div class="form-group"><label for="section">🏫 الشعبة:</label><select id="section" class="form-control" required><option value="">اختر الشعبة</option><option value="1">الشعبة الأولى</option><option value="2">الشعبة الثانية</option><option value="3">الشعبة الثالثة</option><option value="4">الشعبة الرابعة</option><option value="5">الشعبة الخامسة</option><option value="6">الشعبة السادسة</option></select></div><div class="form-group"><label>🎨 اختر رمزك المميز (إجباري):</label><div class="icon-selector" id="iconSelector"><div class="icon-option" data-icon="🌟" style="animation-delay: 0.1s">🌟</div><div class="icon-option" data-icon="🚀" style="animation-delay: 0.2s">🚀</div><div class="icon-option" data-icon="⚡" style="animation-delay: 0.3s">⚡</div><div class="icon-option" data-icon="🔥" style="animation-delay: 0.4s">🔥</div><div class="icon-option" data-icon="💎" style="animation-delay: 0.5s">💎</div><div class="icon-option" data-icon="🎯" style="animation-delay: 0.6s">🎯</div><div class="icon-option" data-icon="🏆" style="animation-delay: 0.7s">🏆</div><div class="icon-option" data-icon="👑" style="animation-delay: 0.8s">👑</div><div class="icon-option" data-icon="🦁" style="animation-delay: 0.9s">🦁</div><div class="icon-option" data-icon="🦅" style="animation-delay: 1.0s">🦅</div><div class="icon-option" data-icon="🐺" style="animation-delay: 1.1s">🐺</div><div class="icon-option" data-icon="🦖" style="animation-delay: 1.2s">🦖</div><div class="icon-option" data-icon="🌙" style="animation-delay: 1.3s">🌙</div><div class="icon-option" data-icon="☀️" style="animation-delay: 1.4s">☀️</div><div class="icon-option" data-icon="⭐" style="animation-delay: 1.5s">⭐</div><div class="icon-option" data-icon="🌈" style="animation-delay: 1.6s">🌈</div><div class="icon-option" data-icon="🎪" style="animation-delay: 1.7s">🎪</div><div class="icon-option" data-icon="🎭" style="animation-delay: 1.8s">🎭</div></div><div class="help-text">اختر رمزاً يمثلك في المسابقة (لا يمكن تكراره في نفس الصف والشعبة)</div><div id="iconValidation" class="validation-message"></div></div><button type="submit" class="btn" id="submitBtn">🚀 دخول المسابقة</button></form><div id="status" class="status"></div><div class="developer-info"><div class="developer-name">تنفيذ وإشراف: الأستاذ نواف الصبحي</div><div class="school-year">متوسطة المنذر بن عمرو الأنصاري - 2025</div></div></div>
    </div>
    <script type="module">
        const firebaseConfig={apiKey:"AIzaSyA5yepZwrOlqFiV_KkVHp9dBaaT65pgdRo",authDomain:"nafs-competition.firebaseapp.com",projectId:"nafs-competition",storageBucket:"nafs-competition.firebasestorage.app",messagingSenderId:"182205828634",appId:"1:182205828634:web:dee889f770eb52ff668ba3",measurementId:"G-MLR86M05H7"};
        import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';import{getAuth,signInAnonymously}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';import{getFirestore,collection,query,where,getDocs,doc,setDoc,serverTimestamp,addDoc}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);
        let selectedIcon='',currentUser=null,attemptCount=0,MAX_ATTEMPTS=5,isSubmitting=false;
        document.addEventListener('DOMContentLoaded',async()=>{await initializeAuth();checkExistingSession();setupEventListeners();setupAdvancedSecurity();loadIconsWithDelay();});
        async function initializeAuth(){try{const userCredential=await signInAnonymously(auth);currentUser=userCredential.user;showStatus('✅ تم الاتصال بالخادم','success');setTimeout(()=>document.getElementById('status').style.display='none',2000);}catch(error){console.error('خطأ في المصادقة:',error);showStatus('⚠️ مشكلة في الاتصال بالخادم. يرجى إعادة تحميل الصفحة.','error');}}
        function checkExistingSession(){const savedData=localStorage.getItem('nafes_student_data');if(savedData){try{const studentData=JSON.parse(savedData);if(studentData.studentId&&studentData.fullName&&(Date.now()-studentData.timestamp)<24*60*60*1000){showExistingSession(studentData);return true;}else{localStorage.removeItem('nafes_student_data');}}catch(error){console.error('خطأ في تحليل بيانات الجلسة:',error);localStorage.removeItem('nafes_student_data');}}return false;}
        function showExistingSession(studentData){const existingSession=document.getElementById('existingSession');const registrationForm=document.getElementById('registrationForm');const sessionDetails=document.getElementById('sessionDetails');sessionDetails.innerHTML=`${studentData.icon} <strong>${studentData.fullName}</strong><br>${studentData.grade} - الشعبة ${studentData.section}<br><small style="opacity:0.8;">آخر نشاط: ${formatRelativeTime(studentData.timestamp)}</small>`;existingSession.classList.remove('hidden');registrationForm.classList.add('hidden');document.getElementById('continueBtn').addEventListener('click',e=>{e.preventDefault();continueToQuiz();});document.getElementById('newSessionBtn').addEventListener('click',()=>startNewSession());}
        function formatRelativeTime(timestamp){const now=Date.now();const diff=now-timestamp;const minutes=Math.floor(diff/60000);const hours=Math.floor(diff/3600000);const days=Math.floor(diff/86400000);if(minutes<60)return`منذ ${minutes} دقيقة`;else if(hours<24)return`منذ ${hours} ساعة`;else return`منذ ${days} يوم`;}
        function continueToQuiz(){const savedData=localStorage.getItem('nafes_student_data');if(savedData){try{const studentData=JSON.parse(savedData);window.location.href='thank-you.html';}catch(error){console.error('خطأ في البيانات:',error);startNewSession();}}else startNewSession();}
        function startNewSession(){if(confirm('هل أنت متأكد من بدء جلسة جديدة؟ سيتم حذف البيانات السابقة.')){localStorage.removeItem('nafes_student_data');localStorage.removeItem('nafes_quiz_progress');document.getElementById('existingSession').classList.add('hidden');document.getElementById('registrationForm').classList.remove('hidden');showStatus('تم حذف الجلسة السابقة. يمكنك التسجيل مرة أخرى.','success');}}
        function loadIconsWithDelay(){const icons=document.querySelectorAll('.icon-option');icons.forEach((icon,index)=>{setTimeout(()=>icon.style.opacity='1',index*100);});}
        function setupAdvancedSecurity(){let devtools={open:false,orientation:null};const threshold=160;const detectDevTools=()=>{if(window.outerHeight-window.innerHeight>threshold||window.outerWidth-window.innerWidth>threshold){if(!devtools.open){devtools.open=true;showSecurityOverlay();}}else{if(devtools.open){devtools.open=false;hideSecurityOverlay();}}};setInterval(detectDevTools,500);document.addEventListener('contextmenu',e=>e.preventDefault());document.addEventListener('keydown',function(e){if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='J'))||(e.ctrlKey&&(e.key==='u'||e.key==='U'||e.key==='s'||e.key==='S'||e.key==='a'||e.key==='A'||e.key==='c'||e.key==='C'||e.key==='v'||e.key==='V'))){e.preventDefault();showSecurityOverlay();return false;}});document.addEventListener('selectstart',e=>e.preventDefault());document.addEventListener('dragstart',e=>e.preventDefault());setInterval(()=>console.clear(),3000);Object.freeze(window);}
        function showSecurityOverlay(){document.getElementById('securityOverlay').style.display='flex';setTimeout(()=>document.getElementById('securityOverlay').style.display='none',3000);}
        function setupEventListeners(){document.querySelectorAll('.icon-option').forEach(option=>{option.addEventListener('click',function(){document.querySelectorAll('.icon-option').forEach(opt=>opt.classList.remove('selected'));this.classList.add('selected');selectedIcon=this.dataset.icon;clearValidationMessage('iconValidation');});});['firstName','fatherName','grandFatherName','familyName'].forEach(id=>{document.getElementById(id).addEventListener('input',validateNameInput);document.getElementById(id).addEventListener('blur',validateName);});document.getElementById('loginForm').addEventListener('submit',handleSubmit);document.querySelector('.pin-close').onclick=()=>document.getElementById('pinModal').style.display='none';document.getElementById('pinOk').onclick=()=>{document.getElementById('pinModal').style.display='none');showStatus('✅ تم تسجيل دخولك بنجاح! جاري التوجيه للمسابقة...','success');setTimeout(()=>window.location.href='thank-you.html',1500);});}
        function validateNameInput(e){const value=e.target.value;const arabicRegex=/^[\u0600-\u06FF\s]*$/;if(value&&!arabicRegex.test(value)){e.target.value=value.replace(/[^\u0600-\u06FF\s]/g,'');showValidationMessage('nameValidation','يجب استخدام الأحرف العربية فقط',false);}}
        function validateName(){const firstName=document.getElementById('firstName').value.trim();const fatherName=document.getElementById('fatherName').value.trim();const grandFatherName=document.getElementById('grandFatherName').value.trim();const familyName=document.getElementById('familyName').value.trim();const inputs=[firstName,fatherName,grandFatherName,familyName];const inputElements=['firstName','fatherName','grandFatherName','familyName'];inputElements.forEach(id=>document.getElementById(id).classList.remove('error','success'));if(!firstName||!fatherName||!grandFatherName||!familyName){showValidationMessage('nameValidation','يجب إدخال الاسم الرباعي كاملاً',false);return false;}for(let i=0;i<inputs.length;i++){if(inputs[i].length<2){showValidationMessage('nameValidation','كل جزء من الاسم يجب أن يكون حرفين على الأقل',false);document.getElementById(inputElements[i]).classList.add('error');return false;}if(!/^[\u0600-\u06FF\s]+$/.test(inputs[i])){showValidationMessage('nameValidation','يجب استخدام الأحرف العربية فقط',false);document.getElementById(inputElements[i]).classList.add('error');return false;}}inputElements.forEach(id=>document.getElementById(id).classList.add('success'));showValidationMessage('nameValidation','✅ الاسم صحيح',true);return true;}
        function validateIcon(){if(!selectedIcon){showValidationMessage('iconValidation','يجب اختيار رمز مميز',false);return false;}showValidationMessage('iconValidation','✅ تم اختيار الرمز',true);return true;}
        async function checkNameDuplication(fullName){try{const q=query(collection(db,'students'),where('fullName','==',fullName));const querySnapshot=await getDocs(q);return !querySnapshot.empty;}catch(error){console.error('خطأ في فحص التكرار:',error);return false;}}
        async function checkIconDuplication(icon,grade,section){try{const q=query(collection(db,'students'),where('icon','==',icon),where('grade','==',grade),where('section','==',section));const querySnapshot=await getDocs(q);return !querySnapshot.empty;}catch(error){console.error('خطأ في فحص تكرار الرمز:',error);return false;}}
        async function handleSubmit(e){e.preventDefault();while(!currentUser){showStatus('⏳ جاري الاتصال بالخادم...','loading');await new Promise(r=>setTimeout(r,300));}if(isSubmitting)return;try{checkRateLimit();if(!validateName()||!validateIcon()){showStatus('⚠️ يرجى تصحيح البيانات المدخلة','error');return;}const firstName=document.getElementById('firstName').value.trim();const fatherName=document.getElementById('fatherName').value.trim();const grandFatherName=document.getElementById('grandFatherName').value.trim();const familyName=document.getElementById('familyName').value.trim();const fullName=`${firstName} ${fatherName} ${grandFatherName} ${familyName}`;const grade=document.getElementById('grade').value;const section=document.getElementById('section').value;if(!grade||!section){showStatus('⚠️ يرجى اختيار الصف والشعبة','error');return;}isSubmitting=true;const submitBtn=document.getElementById('submitBtn');submitBtn.disabled=true;submitBtn.innerHTML='⏳ جاري التحقق... <div class="loading-spinner"></div>';showStatus('🔄 جاري التحقق من صحة البيانات...','loading');const nameExists=await checkNameDuplication(fullName);if(nameExists){throw new Error('هذا الاسم مسجل مسبقاً في النظام');}const iconExists=await checkIconDuplication(selectedIcon,grade,section);if(iconExists){throw new Error(`الرمز ${selectedIcon} مستخدم بالفعل في ${grade} - الشعبة ${section}`);}const studentId=generateStudentId(fullName,grade,section);const pin=Math.floor(1000+Math.random()*9000);await setDoc(doc(db,'students',studentId),{studentId,firstName,fatherName,grandFatherName,familyName,fullName,grade,section,icon:selectedIcon,pin,registrationTime:serverTimestamp(),isActive:true,totalCompetitions:0,totalScore:0,averageScore:0,lastActivity:serverTimestamp(),ipAddress:await getClientIP(),userAgent:navigator.userAgent.substring(0,100)});const studentData={studentId,fullName,grade,section,icon:selectedIcon,pin,timestamp:Date.now()};localStorage.setItem('nafes_student_data',JSON.stringify(studentData));document.getElementById('pinDisplay').textContent=pin;document.getElementById('pinModal').style.display='flex';}catch(error){console.error('خطأ في التسجيل:',error);showStatus(`❌ ${error.message}`,'error');isSubmitting=false;const submitBtn=document.getElementById('submitBtn');submitBtn.disabled=false;submitBtn.innerHTML='🚀 دخول المسابقة';}}
        async function getClientIP(){try{const response=await fetch('https://api.ipify.org?format=json');const data=await response.json();return data.ip;}catch(error){return'unknown';}}
        function generateStudentId(fullName,grade,section){let nameHash='';for(let i=0;i<fullName.length;i++){nameHash+=fullName.charCodeAt(i).toString(36);}nameHash=nameHash.substring(0,8);const gradeCode=grade.replace(/[^0-9]/g,'');const timestamp=Date.now().toString().slice(-6);const random=Math.random().toString(36).substring(2,6);return`STD_${gradeCode}_${section}_${nameHash}_${timestamp}_${random}`;}
        function showStatus(message,type){const statusDiv=document.getElementById('status');statusDiv.textContent=message;statusDiv.className=`status ${type}`;statusDiv.style.display='block';if(type==='success'||type==='error'){setTimeout(()=>statusDiv.style.display='none',5000);}}
        function showValidationMessage(elementId,message,isSuccess){const element=document.getElementById(elementId);element.textContent=message;element.className=`validation-message ${isSuccess?'success':''}`;element.style.transform='scale(1.05)';setTimeout(()=>element.style.transform='scale(1)',200);}
        function clearValidationMessage(elementId){const element=document.getElementById(elementId);element.textContent='';element.className='validation-message';}
        window.addEventListener('error',function(e){console.error('JavaScript Error:',e.error);if(currentUser){try{addDoc(collection(db,'error_logs'),{error:e.message,timestamp:serverTimestamp(),userAgent:navigator.userAgent.substring(0,100),url:window.location.href});}catch(logError){console.error('Failed to log error:',logError);}}});
        setInterval(async()=>{if(currentUser){try{await testDatabaseConnection();}catch(error){showStatus('⚠️ انقطع الاتصال بالخادم. يرجى إعادة تحميل الصفحة.','error');}}},30000);
    </script>
</body>
</html>
